<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1:1 í™”ìƒ ì±„íŒ…</title>
    <!-- PeerJS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    
    <!-- íŒì„œ ë„êµ¬ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ (ìƒˆ ì°½ì—ì„œ ë¡œë“œë¨) -->
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #333;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-screen {
            background-color: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            box-sizing: border-box;
        }

        #login-screen h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 2rem;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            background-color: #ecf0f1;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .tab-btn:first-child {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        
        .tab-btn:last-child {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .tab-btn.active {
            background-color: #3498db;
            color: white;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ */
        }

        .btn {
            width: 100%;
            padding: 0.9rem;
            border: none;
            border-radius: 8px;
            background-color: #3498db;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #2ecc71;
        }
        .btn-secondary:hover {
            background-color: #27ae60;
        }

        #teacher-panel {
            display: none; /* êµì‚¬ ë¹„ë²ˆ ì¸ì¦ í›„ í‘œì‹œ */
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #ecf0f1;
        }

        #shareable-url {
            background-color: #ecf0f1;
            padding: 0.8rem;
            border-radius: 8px;
            word-break: break-all;
            margin-top: 1rem;
        }

        /* íšŒì˜ì‹¤ í™”ë©´ */
        #meeting-room {
            display: none;
            width: 100vw;
            height: 100vh;
            background-color: #2c3e50;
            flex-direction: column;
            overflow: hidden;
        }
        
        #main-content {
            display: flex;
            flex: 1;
            height: calc(100% - 80px); /* ì»¨íŠ¸ë¡¤ ë°” ë†’ì´ ì œì™¸ */
        }

        #video-container {
            flex: 1;
            display: flex;
            flex-direction: row; /* columnì—ì„œ rowë¡œ ë³€ê²½ */
            background-color: #34495e;
            padding: 1rem;
            gap: 1rem;
            box-sizing: border-box;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        
        /* í™•ëŒ€ ëª¨ë“œ (Enlarge) */
        #video-container.theater-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%; /* calc() ì œê±°, ì±„íŒ…ì°½ì€ fixedë¡œ ëœ¸ */
            height: 100vh;
            z-index: 1000;
            padding: 1rem;
            background: #2c3e50;
        }
        
        #video-container.theater-mode #local-video-wrapper {
             flex: 1; /* ë¡œì»¬ ë¹„ë””ì˜¤ê°€ ê½‰ ì°¨ë„ë¡ */
        }
        
        /* #video-container.theater-mode #remote-video-wrapper {
            /* PIPë¡œ ì „í™˜ë˜ë¯€ë¡œ ìˆ¨ê¹€ (PIP APIê°€ ì²˜ë¦¬) */
            /* display: none; */ 
        /* } */


        .video-wrapper {
            position: relative;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            flex: 1; /* ê¸°ë³¸ì ìœ¼ë¡œ 1:1 ë¹„ìœ¨ */
            min-height: 0; /* flexbox ë†’ì´ ë¬¸ì œ í•´ê²° */
        }

        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .video-wrapper:hover .video-controls {
            opacity: 1;
        }

        .video-controls button {
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .video-controls button:hover {
            background: rgba(0,0,0,0.8);
        }

        /* ì±„íŒ…ì°½ (ìš°ì¸¡) */
        #chat-container {
            width: 350px;
            background-color: white;
            display: flex;
            flex-direction: column;
            height: 100%; /* main-content ë†’ì´ì— ë§ì¶¤ */
            border-left: 1px solid #bdc3c7;
            box-sizing: border-box;
            z-index: 1001; /* í™•ëŒ€ ëª¨ë“œë³´ë‹¤ ìœ„ì— */
            transition: width 0.3s ease;
            position: relative; /* ìì‹ ë²„íŠ¼ ìœ„ì¹˜ìš© */
        }
        
        /* í™•ëŒ€ ëª¨ë“œ ì‹œ ì±„íŒ…ì°½ ìŠ¤íƒ€ì¼ */
        #chat-container.in-theater-mode {
            position: fixed;
            top: 1rem;
            right: 1rem;
            height: calc(100vh - 2rem - 80px); /* ìœ„ì•„ë˜ ì—¬ë°±, ì»¨íŠ¸ë¡¤ë°” ë†’ì´ ì œì™¸ */
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-radius: 8px;
            overflow: hidden;
        }
        
        #chat-container.enlarged {
            width: 600px;
        }
        
        #chat-container.hidden {
            display: none;
        }
        
        /* ì±„íŒ…ì°½ ìˆ¨ê²¨ì¡Œì„ ë•Œ ë©”ì¸ ì»¨í…ì¸  ì¡°ì • */
        #main-content.chat-hidden #video-container {
            width: 100%;
        }

        #chat-header {
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
            border-bottom: 1px solid #ecf0f1;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ë“œë˜ê·¸ ê°€ëŠ¥í•œ í—¤ë” */
        #chat-header.draggable-header {
            cursor: move;
        }
        
        #chat-header-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: #7f8c8d;
            padding: 0 5px;
        }
        #chat-header-buttons button:hover {
            color: #34495e;
        }

        #messages-log {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .message {
            padding: 0.6rem 0.9rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message strong { /* Used for sender name */
            display: block;
            font-size: 0.9rem;
            margin-bottom: 4px;
            color: #555;
        }
        
        .message.local strong {
            color: #fdfdfd;
        }
        
        .message img {
            max-width: 100%;
            border-radius: 8px;
            cursor: pointer;
        }

        .message.local {
            background-color: #3498db;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.remote {
            background-color: #ecf0f1;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .message.system {
            background-color: #f1c40f;
            color: #333;
            align-self: center;
            font-size: 0.9rem;
            font-style: italic;
        }
        
        .message a {
            color: #fff;
            font-weight: 600;
            text-decoration: underline;
        }
        
        .message.remote a {
            color: #2980b9;
        }

        #chat-input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #ecf0f1;
        }

        #chat-input-area input[type="text"] {
            flex: 1;
            border: 1px solid #bdc3c7;
            border-radius: 20px;
            padding: 0.7rem 1rem;
            margin-right: 0.5rem;
        }

        #chat-input-area button, #file-input-label, #image-input-label {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s;
            padding: 0 0.5rem;
        }
        
        #chat-input-area button:hover, #file-input-label:hover, #image-input-label:hover {
            color: #3498db;
        }
        
        #file-input, #image-input {
            display: none;
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
        #controls-bar {
            height: 80px;
            background-color: #34495e;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 0 1rem;
            box-sizing: border-box;
            border-top: 1px solid #4a6580;
        }

        .control-btn {
            background-color: #5d7ca0;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s;
        }

        .control-btn:hover {
            background-color: #7a9ac4;
        }

        /* ì¼œì§„ ìƒíƒœ (íŒŒë€ìƒ‰) */
        .control-btn.on {
            background-color: #3498db;
        }
        .control-btn.on:hover {
            background-color: #5dade2;
        }

        /* êº¼ì§„ ìƒíƒœ (ë¹¨ê°„ìƒ‰) */
        .control-btn.off {
            background-color: #e74c3c;
        }
        .control-btn.off:hover {
            background-color: #ec7063;
        }
        
        #end-call-btn {
            background-color: #e74c3c;
        }
        #end-call-btn:hover {
            background-color: #c0392b;
        }
        
        /* ì±„íŒ… ë³´ì´ê¸° ë²„íŠ¼ */
        #show-chat-btn {
            position: fixed;
            bottom: 90px; /* ì»¨íŠ¸ë¡¤ ë°” ìœ„ */
            right: 20px;
            z-index: 1002;
            background-color: #3498db;
        }
        #show-chat-btn:hover {
            background-color: #2980b9;
        }
        
        /* ë…¹í™” ì˜µì…˜ ëª¨ë‹¬ */
        #record-options-modal {
            position: fixed;
            bottom: 90px; /* ì»¨íŠ¸ë¡¤ ë°” ìœ„ */
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1003;
            padding: 1.5rem;
            width: 300px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        #record-options-modal h4 {
            margin: 0 0 0.5rem 0;
            text-align: center;
            color: #2c3e50;
        }
        
        #record-options-modal button {
            padding: 0.8rem;
            border: 1px solid #bdc3c7;
            background-color: #ecf0f1;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        #record-options-modal button:hover {
            background-color: #dfe6e9;
        }
        
        #record-options-modal button.warning {
            border-color: #e74c3c;
            color: #e74c3c;
        }
        #record-options-modal button.warning:hover {
            background-color: #fadbd8;
        }
        
        /* ìœ í‹¸ë¦¬í‹° */
        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>

    <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen">
        <h1>í™”ìƒ ì±„íŒ… ì‹œì‘í•˜ê¸°</h1>

        <div class="login-tabs">
            <button class="tab-btn active" onclick="showLoginTab('student')">í•™ìƒ</button>
            <button class="tab-btn" onclick="showLoginTab('teacher')">êµì‚¬</button>
        </div>

        <!-- í•™ìƒ ë¡œê·¸ì¸ í¼ -->
        <div id="student-form" class="login-form active">
            <div class="form-group">
                <label for="student-name">ì´ë¦„</label>
                <input type="text" id="student-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label for="student-meeting-id">í™”ìƒ ID</label>
                <input type="text" id="student-meeting-id" placeholder="êµì‚¬ì—ê²Œ ë°›ì€ ID ì…ë ¥">
            </div>
            <div class="form-group">
                <label for="student-meeting-pass">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="student-meeting-pass" placeholder="íšŒì˜ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            </div>
            <button id="join-btn" class="btn">ì°¸ì—¬í•˜ê¸°</button>
        </div>

        <!-- êµì‚¬ ë¡œê·¸ì¸ í¼ -->
        <div id="teacher-form" class="login-form">
            <div class="form-group">
                <label for="teacher-pass">êµì‚¬ ì¸ì¦</label>
                <input type="password" id="teacher-pass" placeholder="êµì‚¬ ì¸ì¦ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            </div>
            <button id="teacher-auth-btn" class="btn">ì¸ì¦í•˜ê¸°</button>

            <!-- êµì‚¬ ì¸ì¦ í›„ í‘œì‹œë˜ëŠ” íŒ¨ë„ -->
            <div id="teacher-panel">
                <div class="form-group">
                    <label for="teacher-meeting-id">í™”ìƒ ID ì„¤ì •</label>
                    <input type="text" id="teacher-meeting-id" placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±">
                </div>
                <div class="form-group">
                    <label for="teacher-meeting-pass">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</label>
                    <input type="password" id="teacher-meeting-pass" placeholder="í•™ìƒì´ ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸">
                </div>
                <button id="generate-link-btn" class="btn btn-secondary">ê³µìœ  ë§í¬ ìƒì„±</button>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>ê³µìœ ìš© ì£¼ì†Œ:</label>
                    <div id="shareable-url">(ë§í¬ ìƒì„± í›„ í‘œì‹œë©ë‹ˆë‹¤)</div>
                </div>
                <button id="start-teacher-meeting-btn" class="btn hidden" style="margin-top: 1rem;">íšŒì˜ ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- 2. íšŒì˜ì‹¤ í™”ë©´ -->
    <div id="meeting-room">
        <!-- ë©”ì¸ ì»¨í…ì¸  (ë¹„ë””ì˜¤) -->
        <div id="main-content">
            <div id="video-container">
                <!-- ì›ê²© ë¹„ë””ì˜¤ -->
                <div id="remote-video-wrapper" class="video-wrapper">
                    <video id="remote-video" playsinline autoplay></video>
                    <div class="video-controls">
                        <!-- <button id="remote-fullscreen-btn" title="ì „ì²´í™”ë©´">FS</button> -->
                        <button id="remote-capture-btn" title="ìº¡ì²˜">ğŸ“¸</button>
                    </div>
                </div>
                <!-- ë¡œì»¬ ë¹„ë””ì˜¤ -->
                <div id="local-video-wrapper" class="video-wrapper">
                    <video id="local-video" playsinline autoplay muted></video>
                    <div class="video-controls">
                        <!-- <button id="local-fullscreen-btn" title="ì „ì²´í™”ë©´">FS</button> -->
                        <button id="local-capture-btn" title="ìº¡ì²˜">ğŸ“¸</button>
                    </div>
                </div>
            </div>
            
            <!-- ì±„íŒ…ì°½ (ìš°ì¸¡) -->
            <div id="chat-container">
                <div id="chat-header">
                    <span>ì±„íŒ…</span>
                    <div id="chat-header-buttons">
                        <button id="popout-chat-btn" title="ìƒˆ ì°½">â†—ï¸</button>
                        <button id="toggle-chat-size-btn" title="í™•ëŒ€/ì¶•ì†Œ">â†”</button>
                        <button id="hide-chat-btn" title="ìˆ¨ê¸°ê¸°">X</button>
                    </div>
                </div>
                <div id="messages-log">
                    <!-- ë©”ì‹œì§€ ë™ì  ì¶”ê°€ -->
                </div>
                <div id="chat-input-area">
                    <input type="file" id="file-input">
                    <label for="file-input" id="file-input-label" title="íŒŒì¼ ì²¨ë¶€">ğŸ“</label>
                    <input type="file" id="image-input" accept="image/*">
                    <label for="image-input" id="image-input-label" title="ì´ë¯¸ì§€ ì²¨ë¶€">ğŸ–¼ï¸</label>
                    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                    <button id="send-chat-btn" title="ì „ì†¡">â¤</button>
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” -->
        <div id="controls-bar">
            <button id="mic-btn" class="control-btn on" title="ë§ˆì´í¬ ì¼œê¸°/ë„ê¸°">ğŸ¤</button>
            <button id="video-btn" class="control-btn on" title="ì¹´ë©”ë¼ ì¼œê¸°/ë„ê¸°">ğŸ“·</button>
            <button id="switch-cam-btn" class="control-btn" title="ì¹´ë©”ë¼ ì „í™˜">ğŸ”„</button>
            <button id="share-screen-btn" class="control-btn" title="í™”ë©´ ê³µìœ ">ğŸ–¥ï¸</button>
            <button id="enlarge-btn" class="control-btn" title="í™”ë©´ í™•ëŒ€/PIP">ğŸ”³</button>
            <button id="record-btn" class="control-btn" title="ë…¹í™”">ğŸ”´</button>
            <button id="whiteboard-btn" class="control-btn" title="íŒì„œ">âœï¸</button>
            <button id="end-call-btn" class="control-btn" title="í†µí™” ì¢…ë£Œ">ğŸ“</button>
        </div>
    </div>
    
    <!-- ë…¹í™” ì˜µì…˜ ëª¨ë‹¬ -->
    <div id="record-options-modal" class="hidden">
        <h4>ë…¹í™” ëŒ€ìƒ ì„ íƒ</h4>
        <button data-record-target="remote">ìƒëŒ€ë°© í™”ë©´</button>
        <button data-record-target="local">ë‚´ í™”ë©´ / ê³µìœ  í™”ë©´</button>
        <button data-record-target="combined">ì „ì²´ (í•©ì„±) í™”ë©´</button>
        <button id="cancel-record-btn" class="warning">ì·¨ì†Œ</button>
    </div>
    
    <!-- ì±„íŒ… ë³´ì´ê¸° ë²„íŠ¼ (ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
    <button id="show-chat-btn" class="control-btn hidden" title="ì±„íŒ… ë³´ì´ê¸°">ğŸ’¬</button>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let peer;
        let localStream;
        let remoteStream;
        let currentCall;
        let dataConnection;
        let isTeacher = false;
        let currentMeetingId = '';
        let currentMeetingPass = '';
        let myName = '';
        let isMicOn = true;
        let isVideoOn = true;
        let isScreenSharing = false;
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let videoDevices = [];
        let currentVideoDeviceIndex = 0;
        let whiteboardWindow = null;
        let chatWindow = null;
        let remoteName = 'ìƒëŒ€ë°©'; // ì›ê²© ì‚¬ìš©ì ì´ë¦„
        
        // ë…¹í™” í•©ì„±ìš©
        let combinedCanvas = null;
        let combinedCtx = null;
        let animationFrameId = null;
        let audioContext = null;
        let audioDestination = null;
        
        // íŒŒì¼ ì²­í¬ ê´€ë ¨
        const CHUNK_SIZE = 64 * 1024; // 64KB
        let incomingFileData = {};
        let incomingFileChunks = [];
        let receivedBytes = 0;

        // UI ìš”ì†Œ
        const loginScreen = document.getElementById('login-screen');
        const meetingRoom = document.getElementById('meeting-room');
        const studentForm = document.getElementById('student-form');
        const teacherForm = document.getElementById('teacher-form');
        const teacherPanel = document.getElementById('teacher-panel');

        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const messagesLog = document.getElementById('messages-log');
        const chatInput = document.getElementById('chat-input');
        
        // íšŒì˜ì‹¤ UI ìš”ì†Œ
        const mainContent = document.getElementById('main-content');
        const chatContainer = document.getElementById('chat-container');
        const showChatBtn = document.getElementById('show-chat-btn');
        const chatHeader = document.getElementById('chat-header');
        
        // ì±„íŒ… ë“œë˜ê·¸ ê´€ë ¨ ë³€ìˆ˜
        let dragOffsetX = 0;
        let dragOffsetY = 0;


        // --- 1. ë¡œê·¸ì¸ ë° ì´ˆê¸°í™” ë¡œì§ ---

        // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° í™•ì¸
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const pass = urlParams.get('pass');

            if (id && pass) {
                // í•™ìƒ URL ì ‘ì†
                document.getElementById('student-meeting-id').value = id;
                document.getElementById('student-meeting-pass').value = pass;
                document.getElementById('student-meeting-pass').disabled = true; // ë¹„ë²ˆ ì…ë ¥ ë°©ì§€
                showLoginTab('student');
            }
        };

        // íƒ­ ì „í™˜
        function showLoginTab(role) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(form => form.classList.remove('active'));
            
            document.querySelector(`.tab-btn[onclick="showLoginTab('${role}')"]`).classList.add('active');
            document.getElementById(`${role}-form`).classList.add('active');
        }

        // êµì‚¬ ì¸ì¦
        document.getElementById('teacher-auth-btn').onclick = () => {
            const pass = document.getElementById('teacher-pass').value;
            if (pass === 'a123456!') {
                teacherPanel.style.display = 'block';
                // ID ìƒì„± ë¡œì§ì„ 'ê³µìœ  ë§í¬ ìƒì„±' ë²„íŠ¼ìœ¼ë¡œ ì´ë™
                isTeacher = true;
                myName = 'êµì‚¬';
            } else {
                alert('êµì‚¬ ì¸ì¦ ì‹¤íŒ¨!');
            }
        };

        // êµì‚¬: íšŒì˜ ìƒì„±
        document.getElementById('generate-link-btn').onclick = () => {
            currentMeetingPass = document.getElementById('teacher-meeting-pass').value;
            if (!currentMeetingPass) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”.');
                return;
            }
            
            // í™”ìƒ ID ì„¤ì • (ìˆ˜ë™ ë˜ëŠ” ìë™)
            let manualMeetingId = document.getElementById('teacher-meeting-id').value.trim();
            if (manualMeetingId) {
                currentMeetingId = manualMeetingId;
            } else {
                currentMeetingId = 'teacher-' + Math.random().toString(36).substr(2, 9);
                document.getElementById('teacher-meeting-id').value = currentMeetingId; // ìë™ ìƒì„±ëœ ID í‘œì‹œ
            }
            
            // ê³µìœ  URL ìƒì„±
            const url = `${window.location.origin}${window.location.pathname}?id=${currentMeetingId}&pass=${currentMeetingPass}`;
            document.getElementById('shareable-url').textContent = url;
            
            // 'íšŒì˜ ì‹œì‘í•˜ê¸°' ë²„íŠ¼ í‘œì‹œ
            document.getElementById('start-teacher-meeting-btn').classList.remove('hidden');
            // startMeeting(); // -> ì‹œì‘ ë²„íŠ¼ìœ¼ë¡œ ì´ë™
        };
        
        // êµì‚¬: íšŒì˜ ì‹œì‘
        document.getElementById('start-teacher-meeting-btn').onclick = startMeeting;

        // í•™ìƒ: íšŒì˜ ì°¸ì—¬
        document.getElementById('join-btn').onclick = () => {
            myName = document.getElementById('student-name').value;
            currentMeetingId = document.getElementById('student-meeting-id').value;
            currentMeetingPass = document.getElementById('student-meeting-pass').value;
            
            if (!myName || !currentMeetingId || !currentMeetingPass) {
                alert('ì´ë¦„, ID, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            isTeacher = false;
            startMeeting();
        };

        // --- 2. ë¯¸ë””ì–´ ë° PeerJS ì‹œì‘ ---

        async function startMeeting() {
            try {
                // 1. ë¡œì»¬ ë¯¸ë””ì–´ ì‹œì‘
                await startLocalMedia();
                
                // 2. PeerJS ì´ˆê¸°í™”
                initializePeer();
                
                // 3. UI ì „í™˜
                loginScreen.style.display = 'none';
                meetingRoom.style.display = 'flex';

            } catch (err) {
                console.error("ë¯¸ë””ì–´ ì‹œì‘ ì‹¤íŒ¨:", err);
                alert("ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        }

        async function startLocalMedia(videoDeviceId = undefined) {
            // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                audio: true,
                video: {
                    facingMode: 'user', // ê¸°ë³¸ ì „ë©´ ì¹´ë©”ë¼
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            // íŠ¹ì • ì¹´ë©”ë¼ ì¥ì¹˜ IDê°€ ìˆìœ¼ë©´ ì‚¬ìš© (ì¹´ë©”ë¼ ì „í™˜ ì‹œ)
            if (videoDeviceId) {
                constraints.video.deviceId = { exact: videoDeviceId };
            }

            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            localVideo.srcObject = localStream;
            
            // ë¹„ë””ì˜¤ ì¥ì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (íƒœë¸”ë¦¿ ë“± ì§€ì›)
            getVideoDevices();
            
            // PeerJS ì—°ê²°ì´ ì´ë¯¸ ìˆìœ¼ë©´ íŠ¸ë™ êµì²´
            if (currentCall) {
                const videoTrack = localStream.getVideoTracks()[0];
                const audioTrack = localStream.getAudioTracks()[0];
                
                currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video').replaceTrack(videoTrack);
                currentCall.peerConnection.getSenders().find(s => s.track.kind === 'audio').replaceTrack(audioTrack);
            }
        }
        
        // ë¹„ë””ì˜¤ ì¥ì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function getVideoDevices() {
             try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(device => device.kind === 'videoinput');
                // console.log("ë¹„ë””ì˜¤ ì¥ì¹˜:", videoDevices);
                document.getElementById('switch-cam-btn').classList.toggle('hidden', videoDevices.length <= 1);
            } catch (e) {
                console.error("ì¥ì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", e);
            }
        }

        function initializePeer() {
            if (isTeacher) {
                peer = new Peer(currentMeetingId); // êµì‚¬ëŠ” ì§€ì •ëœ ID ì‚¬ìš©
            } else {
                peer = new Peer(); // í•™ìƒì€ ëœë¤ ID ì‚¬ìš©
            }

            peer.on('open', id => {
                console.log('PeerJS ID:', id);
                if (!isTeacher) {
                    // í•™ìƒì€ êµì‚¬ì—ê²Œ ë°ì´í„° ì—°ê²° ë° í†µí™” ìš”ì²­
                    connectToTeacher();
                }
            });

            // êµì‚¬: í•™ìƒì˜ ë°ì´í„° ì—°ê²° ìˆ˜ì‹ 
            peer.on('connection', conn => {
                console.log('ë°ì´í„° ì—°ê²° ìˆ˜ì‹ :', conn.peer);
                setupDataConnection(conn);
            });

            // êµì‚¬: í•™ìƒì˜ ì˜ìƒ í†µí™” ìˆ˜ì‹ 
            peer.on('call', call => {
                console.log('ì˜ìƒ í†µí™” ìˆ˜ì‹ :', call.peer);
                
                // êµì‚¬ ì¸¡ì—ì„œë§Œ answer (í•™ìƒì€ callë§Œ í•¨)
                // -> ìˆ˜ì •: êµì‚¬ê°€ í•™ìƒì˜ pwë¥¼ í™•ì¸í•œ í›„ì—ë§Œ answer
                // -> ìˆ˜ì •2: í•™ìƒì´ ë°ì´í„° ì—°ê²°ë¡œ pw ì „ì†¡ -> êµì‚¬ê°€ í™•ì¸ -> êµì‚¬ê°€ call
                
                // í•™ìƒì´ ë³´ë‚¸ í†µí™” ìš”ì²­ ì‘ë‹µ
                call.answer(localStream);
                setupCall(call);
            });
            
            peer.on('error', err => {
                console.error("PeerJS ì˜¤ë¥˜:", err);
                // alert("ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            });
        }
        
        // í•™ìƒ: êµì‚¬ì—ê²Œ ì—°ê²°
        function connectToTeacher() {
            // 1. ë°ì´í„° ì—°ê²° (ì¸ì¦ìš©)
            console.log(`êµì‚¬(${currentMeetingId})ì—ê²Œ ë°ì´í„° ì—°ê²° ì‹œë„...`);
            dataConnection = peer.connect(currentMeetingId, {
                metadata: { 
                    name: myName, 
                    pass: currentMeetingPass 
                }
            });
            setupDataConnection(dataConnection);

            // 2. ì˜ìƒ í†µí™” (ë°ì´í„° ì—°ê²° ì„±ê³µ í›„ êµì‚¬ê°€ ê±¸ë„ë¡ ìˆ˜ì •)
            // console.log(`êµì‚¬(${currentMeetingId})ì—ê²Œ ì˜ìƒ í†µí™” ì‹œë„...`);
            // currentCall = peer.call(currentMeetingId, localStream);
            // setupCall(currentCall);
        }
        
        // --- 3. ë°ì´í„° ì±„ë„ (ì±„íŒ…, íŒŒì¼, ì¸ì¦) ---

        function setupDataConnection(conn) {
            dataConnection = conn;
            
            dataConnection.on('open', () => {
                console.log('ë°ì´í„° ì±„ë„ ì—´ë¦¼:', dataConnection.peer);
                if (isTeacher) {
                    // êµì‚¬: í•™ìƒ ì¸ì¦ í™•ì¸
                    const metadata = dataConnection.metadata;
                    if (metadata.pass === currentMeetingPass) {
                        console.log(`í•™ìƒ(${metadata.name}) ì¸ì¦ ì„±ê³µ`);
                        remoteName = metadata.name; // í•™ìƒ ì´ë¦„ ì €ì¥
                        // ì¸ì¦ ì„±ê³µ ë©”ì‹œì§€ ì „ì†¡
                        dataConnection.send({ type: 'auth_success' });
                        // êµì‚¬ ì´ë¦„ ì „ì†¡
                        dataConnection.send({ type: 'name_handshake', name: myName });
                        addChatMessage(`'${remoteName}'ë‹˜ì´ ì ‘ì†í–ˆìŠµë‹ˆë‹¤.`, 'system');
                        
                        // ì¸ì¦ ì„±ê³µ í›„ êµì‚¬ê°€ í•™ìƒì—ê²Œ ì˜ìƒ í†µí™” ì‹œì‘
                        console.log(`í•™ìƒ(${dataConnection.peer})ì—ê²Œ ì˜ìƒ í†µí™” ì‹œë„...`);
                        currentCall = peer.call(dataConnection.peer, localStream);
                        setupCall(currentCall);

                    } else {
                        console.log(`í•™ìƒ(${metadata.name}) ì¸ì¦ ì‹¤íŒ¨`);
                        dataConnection.send({ type: 'auth_fail' });
                        dataConnection.close();
                    }
                } else {
                     // í•™ìƒ: ì—°ê²° ì„±ê³µ (ì¸ì¦ ëŒ€ê¸°)
                     console.log('êµì‚¬ì—ê²Œ ë°ì´í„° ì—°ê²° ì„±ê³µ. ì¸ì¦ ëŒ€ê¸° ì¤‘...');
                }
            });

            dataConnection.on('data', data => {
                // console.log("ë°ì´í„° ìˆ˜ì‹ :", data.type);
                switch(data.type) {
                    case 'auth_success': // í•™ìƒì´ ë°›ìŒ
                        console.log("êµì‚¬ ì¸ì¦ ì„±ê³µ!");
                        addChatMessage("ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.", 'system');
                        break;
                    case 'auth_fail': // í•™ìƒì´ ë°›ìŒ
                        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ì—°ê²°ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        peer.destroy();
                        location.reload();
                        break;
                    case 'name_handshake': // í•™ìƒì´ ë°›ìŒ
                        remoteName = data.name; // êµì‚¬ ì´ë¦„ ì €ì¥
                        break;
                    case 'chat':
                        addChatMessage(data.message, 'remote', data.sender);
                        break;
                    case 'file_meta': // íŒŒì¼ ì „ì†¡ ì‹œì‘ (ë©”íƒ€ë°ì´í„°)
                        incomingFileData = {
                            name: data.name,
                            size: data.size,
                            type: data.type,
                            sender: data.sender // ë³´ë‚¸ ì‚¬ëŒ ì´ë¦„ ì €ì¥
                        };
                        incomingFileChunks = [];
                        receivedBytes = 0;
                        addChatMessage(`'${data.sender}'ë‹˜ìœ¼ë¡œë¶€í„° íŒŒì¼ ìˆ˜ì‹  ì¤‘: ${data.name} (${(data.size / 1024 / 1024).toFixed(2)} MB)`, 'system');
                        break;
                    case 'file_chunk': // íŒŒì¼ ì¡°ê° (ì²­í¬)
                        incomingFileChunks.push(data.chunk);
                        receivedBytes += data.chunk.byteLength;
                        
                        // ì§„í–‰ë¥  í‘œì‹œ (ì˜µì…˜)
                        // console.log(`ìˆ˜ì‹  ì§„í–‰: ${(receivedBytes / incomingFileData.size * 100).toFixed(1)}%`);
                        
                        // ëª¨ë“  ì²­í¬ë¥¼ ë°›ìœ¼ë©´ íŒŒì¼ ì¬ì¡°ë¦½
                        if (receivedBytes === incomingFileData.size) {
                            reassembleFile();
                        }
                        break;
                    // case 'file_end': // íŒŒì¼ ì „ì†¡ ì™„ë£Œ (ì²­í¬ í¬ê¸°ë¡œ ëŒ€ì²´)
                    //     reassembleFile();
                    //     break;
                }
            });
            
            dataConnection.on('close', () => {
                addChatMessage('ìƒëŒ€ë°©ì´ ì—°ê²°ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.', 'system');
                remoteVideo.srcObject = null;
                if(currentCall) currentCall.close();
            });
        }
        
        // íŒŒì¼ ì¬ì¡°ë¦½ ë° ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
        function reassembleFile() {
            try {
                const fileBlob = new Blob(incomingFileChunks, { type: incomingFileData.type });
                const url = URL.createObjectURL(fileBlob);
                const senderName = incomingFileData.sender || 'ìƒëŒ€ë°©';
                
                let contentElement;
                
                if (incomingFileData.type.startsWith('image/')) {
                    // It's an image, render it
                    contentElement = document.createElement('img');
                    contentElement.src = url;
                    contentElement.style.maxWidth = '100%';
                    contentElement.style.borderRadius = '8px';
                    contentElement.style.cursor = 'pointer';
                    contentElement.onclick = () => window.open(url);
                    // img.onload = () => { URL.revokeObjectURL(url); } // Let's not revoke
                } else {
                    // It's a file, create download link
                    contentElement = document.createElement('a');
                    contentElement.href = url;
                    contentElement.download = incomingFileData.name;
                    contentElement.textContent = `[íŒŒì¼ ë‹¤ìš´ë¡œë“œ] ${incomingFileData.name}`;
                }
                
                addChatMessage(contentElement, 'remote', senderName);
                
                // ì´ˆê¸°í™”
                incomingFileData = {};
                incomingFileChunks = [];
                receivedBytes = 0;

            } catch (e) {
                console.error("íŒŒì¼ ì¬ì¡°ë¦½ ì‹¤íŒ¨:", e);
                addChatMessage(`íŒŒì¼ ìˆ˜ì‹  ì‹¤íŒ¨: ${incomingFileData.name}`, 'system');
            }
        }

        // --- 4. ì˜ìƒ/ìŒì„± í†µí™” ì„¤ì • ---

        function setupCall(call) {
            currentCall = call;
            
            // ìƒëŒ€ë°© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ 
            call.on('stream', stream => {
                console.log('ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ ');
                remoteStream = stream;
                remoteVideo.srcObject = stream;
                addChatMessage("í™”ìƒ ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", 'system');
            });

            call.on('close', () => {
                console.log('í†µí™” ì¢…ë£Œ');
                remoteVideo.srcObject = null;
                addChatMessage('ìƒëŒ€ë°©ì´ í†µí™”ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.', 'system');
            });
            
            call.on('error', err => {
                console.error("í†µí™” ì˜¤ë¥˜:", err);
            });
        }
        
        // --- 5. ì±„íŒ… ë° íŒŒì¼ ì „ì†¡ UI ---
        
        // ì±„íŒ…ì°½ ì œì–´
        document.getElementById('toggle-chat-size-btn').onclick = () => {
            chatContainer.classList.toggle('enlarged');
        };
        
        document.getElementById('hide-chat-btn').onclick = () => {
            chatContainer.classList.add('hidden');
            mainContent.classList.add('chat-hidden');
            showChatBtn.classList.remove('hidden');
        };
        
        document.getElementById('show-chat-btn').onclick = () => {
            const isTheater = videoContainer.classList.contains('theater-mode');
            
            if (isTheater) {
                // í™•ëŒ€ ëª¨ë“œì—ì„œëŠ” ìƒˆ ì°½ìœ¼ë¡œ ë„ìš°ê¸°
                document.getElementById('popout-chat-btn').click();
                showChatBtn.classList.add('hidden'); // íŒì—… ë„ì› ìœ¼ë‹ˆ ë²„íŠ¼ ìˆ¨ê¹€
            } else {
                // ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” ì¸ë¼ì¸ìœ¼ë¡œ í‘œì‹œ
                chatContainer.classList.remove('hidden');
                mainContent.classList.remove('chat-hidden');
                showChatBtn.classList.add('hidden');
            }
        };
        
        // ì±„íŒ…ì°½ íŒì—…
        document.getElementById('popout-chat-btn').onclick = () => {
            if (chatWindow && !chatWindow.closed) {
                chatWindow.focus();
                return;
            }
            
            // ë©”ì¸ ì±„íŒ…ì°½ ìˆ¨ê¸°ê¸°
            chatContainer.classList.add('hidden');
            mainContent.classList.add('chat-hidden');
            showChatBtn.classList.add('hidden'); // íŒì—… ë„ì› ìœ¼ë‹ˆ ìˆ¨ê¹€ ë²„íŠ¼ë„ ìˆ¨ê¹€
            
            chatWindow = window.open('', 'Chat', 'width=450,height=700,menubar=no,toolbar=no,status=no,scrollbars=no');
            if (chatWindow) {
                chatWindow.document.write(getChatPopupHTML());
                chatWindow.document.close();
                
                // íŒì—…ì´ ë‹«í ë•Œ
                chatWindow.onbeforeunload = () => {
                    chatContainer.classList.remove('hidden');
                    mainContent.classList.remove('chat-hidden');
                    // showChatBtnëŠ” hide-btnì„ ëˆŒë €ì„ ë•Œë§Œ ë³´ì´ë„ë¡ ìœ ì§€
                    chatWindow = null;
                };
            } else {
                alert("íŒì—… ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—…ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.");
                // íŒì—… ì‹¤íŒ¨ ì‹œ UI ì›ìƒë³µêµ¬
                chatContainer.classList.remove('hidden');
                mainContent.classList.remove('chat-hidden');
            }
        };
        
        // íŒì—… ì°½ì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜
        function sendChatMessageFromPopup(message) {
            if (!message.trim() || !dataConnection) return;
            
            dataConnection.send({ type: 'chat', message: message, sender: myName });
            addChatMessage(message, 'local', myName); 
        }
        
        // íŒì—… ì°½ì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜ (íŒŒì¼/ì´ë¯¸ì§€)
        function sendFileFromPopup(file) {
             // 1. ë¡œì»¬ í”„ë¦¬ë·° (ì´ë¯¸ì§€ì¸ ê²½ìš°)
            if (file.type.startsWith('image/')) {
                const localReader = new FileReader();
                localReader.onload = (event) => {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '8px';
                    img.style.cursor = 'pointer';
                    img.onclick = () => window.open(event.target.result);
                    addChatMessage(img, 'local', myName); // ë©”ì¸ ë° íŒì—…ì°½ì— ë™ì‹œ ì¶”ê°€
                };
                localReader.readAsDataURL(file);
            }
            
            // 2. íŒŒì¼ ì „ì†¡
            sendFile(file);
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('send-chat-btn').onclick = sendChatMessage;
        chatInput.onkeyup = (e) => {
            if (e.key === 'Enter') sendChatMessage();
        };

        function sendChatMessage() {
            const message = chatInput.value;
            if (!message.trim() || !dataConnection) return;
            
            dataConnection.send({ type: 'chat', message: message, sender: myName });
            addChatMessage(message, 'local', myName);
            chatInput.value = '';
        }

        // ì±„íŒ… ë©”ì‹œì§€ UIì— ì¶”ê°€
        function addChatMessage(content, type, senderName = null) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', type);
            
            let contentElement;
            
            if (typeof content === 'string') {
                contentElement = document.createTextNode(content);
            } else {
                contentElement = content.cloneNode(true); // DOM ë…¸ë“œ ë³µì‚¬
                if (contentElement.tagName === 'IMG') {
                     // íŒì—…ì— ì „ì†¡ë  ì´ë¯¸ì§€ ì†ŒìŠ¤(blob:)ê°€ ìœ íš¨í•˜ë„ë¡
                    contentElement.src = content.src;
                    contentElement.onclick = () => window.open(content.src);
                } else if (contentElement.tagName === 'A') {
                    contentElement.href = content.href;
                }
            }

            if (senderName && type !== 'system') { // Chat, File, Image message
                const nameSpan = document.createElement('strong');
                nameSpan.textContent = senderName;
                msgDiv.appendChild(nameSpan);
            }
            
            msgDiv.appendChild(contentElement);

            // íŒì—… ì°½ì´ ì—´ë ¤ìˆìœ¼ë©´ íŒì—…ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
            if (chatWindow && !chatWindow.closed) {
                try {
                    // cloneNodeë¡œ ìƒì„±í•œ divë¥¼ outerHTMLë¡œ ì „ë‹¬
                    chatWindow.addMessageToPopup(msgDiv.outerHTML);
                } catch (e) {
                    console.error("íŒì—… ì°½ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:", e);
                }
            }
            
            // ë©”ì¸ ì±„íŒ…ì°½ (íŒì—…ì´ ì•„ë‹ ë•Œë§Œ ë³´ì´ë„ë¡)
            if (!chatWindow || chatWindow.closed) {
                messagesLog.appendChild(msgDiv);
                messagesLog.scrollTop = messagesLog.scrollHeight;
            }
        }

        // íŒŒì¼ ì „ì†¡ (ë¡œì§ ë¶„ë¦¬)
        function sendFile(file) {
            if (!file || !dataConnection) {
                if (!dataConnection) alert("ì±„íŒ…ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            // 100MB ì œí•œ (ì•½ 100 * 1024 * 1024)
            if (file.size > 104857600) {
                 addChatMessage(`íŒŒì¼ í¬ê¸°ê°€ 100MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. (í¬ê¸°: ${(file.size / 1024 / 1024).toFixed(1)}MB)`, 'system');
                 return;
            }
            
            addChatMessage(`íŒŒì¼ ì „ì†¡ ì¤‘: ${file.name}`, 'local', myName);
            
            // 1. ë©”íƒ€ë°ì´í„° ì „ì†¡
            dataConnection.send({
                type: 'file_meta',
                name: file.name,
                size: file.size,
                type: file.type,
                sender: myName // ë³´ë‚¸ ì‚¬ëŒ ì´ë¦„ ì¶”ê°€
            });

            // 2. íŒŒì¼ ì²­í¬ ì „ì†¡
            const reader = new FileReader(); // "new new" ì˜¤íƒ€ ìˆ˜ì •
            reader.onload = (event) => {
                const buffer = event.target.result;
                let offset = 0;

                const sendNextChunk = () => {
                    if (offset >= buffer.byteLength) {
                        // console.log("íŒŒì¼ ì „ì†¡ ì™„ë£Œ:", file.name);
                        return;
                    }
                    
                    if (dataConnection.dataChannel.bufferedAmount > dataConnection.dataChannel.bufferedAmountLowThreshold) {
                        setTimeout(sendNextChunk, 100); // ì ì‹œ ëŒ€ê¸°
                        return;
                    }

                    const chunk = buffer.slice(offset, offset + CHUNK_SIZE);
                    dataConnection.send({ type: 'file_chunk', chunk: chunk });
                    offset += chunk.byteLength;
                    
                    setTimeout(sendNextChunk, 0); 
                };
                
                sendNextChunk();
            };
            reader.readAsArrayBuffer(file);
        }
        
        // íŒŒì¼ ì…ë ¥(input) ë³€ê²½ ì‹œ
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            sendFile(file);
            e.target.value = null; // ë™ì¼ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡
        };
        
        // ì´ë¯¸ì§€ ì…ë ¥(input) ë³€ê²½ ì‹œ
        document.getElementById('image-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // 1. Show local preview
            const localReader = new FileReader();
            localReader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.style.maxWidth = '100%';
                img.style.borderRadius = '8px';
                img.style.cursor = 'pointer';
                img.onclick = () => window.open(event.target.result);
                addChatMessage(img, 'local', myName); 
            };
            localReader.readAsDataURL(file);

            // 2. Send file using existing logic
            sendFile(file);
            e.target.value = null; 
        };
        
        // íŒì„œ ë„êµ¬ì—ì„œ í˜¸ì¶œí•  ìº¡ì²˜ ì „ì†¡ í•¨ìˆ˜
        function sendWhiteboardCapture(dataUrl) {
            if (!dataConnection) {
                alert("ì±„íŒ…ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }
            
            // DataURLì„ Blob -> File ê°ì²´ë¡œ ë³€í™˜
            fetch(dataUrl)
                .then(res => res.blob())
                .then(blob => {
                    const filename = `whiteboard_capture_${new Date().toISOString().split('T')[0]}.png`;
                    const file = new File([blob], filename, { type: 'image/png' });
                    // ë¶„ë¦¬ëœ sendFile í•¨ìˆ˜ í˜¸ì¶œ
                    sendFile(file);
                });
        }


        // --- 6. í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ---

        // ë§ˆì´í¬ ì¼œê¸°/ë„ê¸°
        document.getElementById('mic-btn').onclick = () => {
            if (!localStream) return;
            isMicOn = !isMicOn;
            localStream.getAudioTracks()[0].enabled = isMicOn;
            
            const btn = document.getElementById('mic-btn');
            btn.classList.toggle('on', isMicOn);
            btn.classList.toggle('off', !isMicOn);
            btn.innerHTML = isMicOn ? 'ğŸ¤' : 'ğŸ”‡';
        };

        // ì¹´ë©”ë¼ ì¼œê¸°/ë„ê¸°
        document.getElementById('video-btn').onclick = () => {
            if (!localStream) return;
            isVideoOn = !isVideoOn;
            localStream.getVideoTracks()[0].enabled = isVideoOn;
            
            const btn = document.getElementById('video-btn');
            btn.classList.toggle('on', isVideoOn);
            btn.classList.toggle('off', !isVideoOn);
            btn.innerHTML = isVideoOn ? 'ğŸ“·' : 'ğŸš«';
        };

        // ì¹´ë©”ë¼ ì „í™˜
        document.getElementById('switch-cam-btn').onclick = async () => {
            if (videoDevices.length > 1 && !isScreenSharing) {
                currentVideoDeviceIndex = (currentVideoDeviceIndex + 1) % videoDevices.length;
                const newVideoId = videoDevices[currentVideoDeviceIndex].deviceId;
                await startLocalMedia(newVideoId); // ìƒˆ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ êµì²´
            } else if (isScreenSharing) {
                // í™”ë©´ ê³µìœ  ì¤‘ì§€ (ì¹´ë©”ë¼ë¡œ ë³µê·€)
                await startLocalMedia(videoDevices[currentVideoDeviceIndex]?.deviceId);
                isScreenSharing = false;
                document.getElementById('share-screen-btn').classList.remove('on');
            }
        };

        // í™”ë©´ ê³µìœ 
        document.getElementById('share-screen-btn').onclick = async () => {
            if (isScreenSharing) {
                // í™”ë©´ ê³µìœ  ì¤‘ì§€ (ì¹´ë©”ë¼ë¡œ ë³µê·€)
                await startLocalMedia(videoDevices[currentVideoDeviceIndex]?.deviceId);
                isScreenSharing = false;
                document.getElementById('share-screen-btn').classList.remove('on');
                document.getElementById('switch-cam-btn').classList.toggle('hidden', videoDevices.length <= 1);
            } else {
                // í™”ë©´ ê³µìœ  ì‹œì‘
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true // ì‹œìŠ¤í…œ ì˜¤ë””ì˜¤ ê³µìœ  ì‹œë„
                    });
                    
                    // í™”ë©´ ê³µìœ  ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ êµì²´
                    const screenVideoTrack = screenStream.getVideoTracks()[0];
                    const screenAudioTrack = screenStream.getAudioTracks()[0];
                    
                    if (currentCall) {
                        currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video').replaceTrack(screenVideoTrack);
                        if (screenAudioTrack) {
                             currentCall.peerConnection.getSenders().find(s => s.track.kind === 'audio').replaceTrack(screenAudioTrack);
                        }
                    }
                    
                    // ë¡œì»¬ ë¹„ë””ì˜¤ë„ í™”ë©´ ê³µìœ ë¡œ ë³€ê²½ (ì„ íƒ ì‚¬í•­)
                    localVideo.srcObject = screenStream;
                    localStream = screenStream; // ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ì„ í™”ë©´ ê³µìœ ë¡œ êµì²´
                    
                    isScreenSharing = true;
                    document.getElementById('share-screen-btn').classList.add('on');
                    document.getElementById('switch-cam-btn').classList.remove('hidden'); // ë³µê·€ ë²„íŠ¼ìœ¼ë¡œ í™œì„±í™”

                    // í™”ë©´ ê³µìœ  ì¤‘ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ ì›ë˜ ì¹´ë©”ë¼ë¡œ ë³µê·€
                    screenVideoTrack.onended = () => {
                        if (isScreenSharing) { // ì‚¬ìš©ìê°€ ìˆ˜ë™ ì¤‘ì§€ ì•ˆí–ˆì„ ë•Œë§Œ
                            document.getElementById('share-screen-btn').click();
                        }
                    };

                } catch (err) {
                    console.error("í™”ë©´ ê³µìœ  ì‹¤íŒ¨:", err);
                }
            }
        };

        // í™”ë©´ í™•ëŒ€ (Theater Mode) / PIP
        document.getElementById('enlarge-btn').onclick = async () => {
            const btn = document.getElementById('enlarge-btn');
            videoContainer.classList.toggle('theater-mode');
            chatContainer.classList.toggle('in-theater-mode');
            
            if (videoContainer.classList.contains('theater-mode')) {
                // í™•ëŒ€ ëª¨ë“œ
                btn.innerHTML = 'â†™ï¸'; // ì¶•ì†Œ ì•„ì´ì½˜
                chatHeader.classList.add('draggable-header');
                makeChatDraggable(true);
                
                // ì›ê²© ë¹„ë””ì˜¤ë¥¼ PIPë¡œ
                if (remoteVideo.srcObject && document.pictureInPictureEnabled) {
                    try {
                        await remoteVideo.requestPictureInPicture();
                    } catch (err) {
                        console.error("PIP ì‹œì‘ ì‹¤íŒ¨:", err);
                    }
                }
            } else {
                // ì¶•ì†Œ ëª¨ë“œ
                btn.innerHTML = 'ğŸ”³'; // í™•ëŒ€ ì•„ì´ì½˜
                chatHeader.classList.remove('draggable-header');
                makeChatDraggable(false);
                
                // ë“œë˜ê·¸ë¡œ ë³€ê²½ëœ ìœ„ì¹˜ ì´ˆê¸°í™”
                chatContainer.style.top = '';
                chatContainer.style.left = '';
                
                // PIP ì¢…ë£Œ
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                }
            }
        };

        // ë…¹í™”
        const recordModal = document.getElementById('record-options-modal');
        
        document.getElementById('record-btn').onclick = () => {
            if (isRecording) {
                // ë…¹í™” ì¤‘ì§€
                stopRecording();
            } else {
                // ë…¹í™” ì˜µì…˜ í‘œì‹œ
                if (!remoteStream || !localStream) {
                    alert("ë¡œì»¬ ë° ì›ê²© ë¹„ë””ì˜¤ê°€ ëª¨ë‘ ì—°ê²°ë˜ì–´ì•¼ ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                    return;
                }
                recordModal.classList.remove('hidden');
            }
        };
        
        document.getElementById('cancel-record-btn').onclick = () => {
            recordModal.classList.add('hidden');
        };

        recordModal.querySelectorAll('button[data-record-target]').forEach(btn => {
            btn.onclick = () => {
                const target = btn.getAttribute('data-record-target');
                recordModal.classList.add('hidden');
                startRecording(target);
            };
        });
        
        function startRecording(target) {
            let streamToRecord = null;
            let combinedAudioTrack = null;
            recordedChunks = [];
            
            const options = { mimeType: 'video/webm; codecs=vp9' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                 options.mimeType = 'video/webm; codecs=vp8';
                 if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                     options.mimeType = 'video/webm';
                 }
            }

            try {
                if (target === 'remote') {
                    streamToRecord = remoteStream;
                } else if (target === 'local') {
                    streamToRecord = localStream;
                } else if (target === 'combined') {
                    // 1. ë¹„ë””ì˜¤ í•©ì„± (Canvas)
                    combinedCanvas = document.createElement('canvas');
                    const w = localVideo.videoWidth || 1280;
                    const h = localVideo.videoHeight || 720;
                    combinedCanvas.width = w * 2;
                    combinedCanvas.height = h;
                    combinedCtx = combinedCanvas.getContext('2d');
                    
                    function drawCombinedFrame() {
                        if (!isRecording) return;
                        combinedCtx.fillStyle = '#000';
                        combinedCtx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
                        if (localStream.getVideoTracks()[0].enabled) {
                            combinedCtx.drawImage(localVideo, 0, 0, w, h);
                        }
                        if (remoteStream.getVideoTracks()[0].enabled) {
                            combinedCtx.drawImage(remoteVideo, w, 0, w, h);
                        }
                        animationFrameId = requestAnimationFrame(drawCombinedFrame);
                    }
                    drawCombinedFrame();
                    streamToRecord = combinedCanvas.captureStream(25); // 25 fps
                    
                    // 2. ì˜¤ë””ì˜¤ í•©ì„± (AudioContext)
                    audioContext = new AudioContext();
                    audioDestination = audioContext.createMediaStreamDestination();
                    
                    if (localStream.getAudioTracks().length > 0) {
                        const localAudioSource = audioContext.createMediaStreamSource(localStream);
                        localAudioSource.connect(audioDestination);
                    }
                    if (remoteStream.getAudioTracks().length > 0) {
                        const remoteAudioSource = audioContext.createMediaStreamSource(remoteStream);
                        remoteAudioSource.connect(audioDestination);
                    }
                    
                    combinedAudioTrack = audioDestination.stream.getAudioTracks()[0];
                    streamToRecord.addTrack(combinedAudioTrack);
                }

                if (!streamToRecord) {
                    alert("ë…¹í™”í•  ìŠ¤íŠ¸ë¦¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                
                mediaRecorder = new MediaRecorder(streamToRecord, options);

            } catch (e) {
                alert("ë…¹í™” ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. " + e.message);
                console.error("ë…¹í™” ì‹œì‘ ì˜¤ë¥˜:", e);
                stopRecordingCleanup(); // ìì› í•´ì œ
                return;
            }

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `recording_${target}_${new Date().toISOString()}.webm`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                stopRecordingCleanup(); // ìì› í•´ì œ
            };

            mediaRecorder.start();
            isRecording = true;
            document.getElementById('record-btn').classList.add('off'); // ë…¹í™” ì¤‘ (ë¹¨ê°„ìƒ‰)
            document.getElementById('record-btn').innerHTML = 'â– ';
        }
        
        function stopRecording() {
             if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }
        
        // ë…¹í™” ì¤‘ì§€ í›„ ìì› ì •ë¦¬
        function stopRecordingCleanup() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            if (audioDestination) {
                audioDestination.stream.getTracks().forEach(t => t.stop());
                audioDestination = null;
            }
            if (combinedCtx) {
                combinedCtx.clearRect(0, 0, combinedCanvas.width, combinedCanvas.height);
                combinedCanvas = null;
                combinedCtx = null;
            }
            
            isRecording = false;
            const btn = document.getElementById('record-btn');
            btn.classList.remove('off'); // ë¹¨ê°„ìƒ‰ ì¤‘ì§€
            btn.innerHTML = 'ğŸ”´';
        }

        // íŒì„œ (ìƒˆ ì°½)
        document.getElementById('whiteboard-btn').onclick = () => {
            if (whiteboardWindow && !whiteboardWindow.closed) {
                whiteboardWindow.focus();
            } else {
                whiteboardWindow = window.open('', 'Whiteboard', 'width=1000,height=700,menubar=no,toolbar=no');
                whiteboardWindow.document.write(getWhiteboardHTML());
                whiteboardWindow.document.close();
            }
        };
        
        // í†µí™” ì¢…ë£Œ
        document.getElementById('end-call-btn').onclick = () => {
            if (peer) {
                peer.destroy(); // PeerJS ì—°ê²° ì™„ì „ ì¢…ë£Œ
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            if(whiteboardWindow && !whiteboardWindow.closed) {
                whiteboardWindow.close();
            }
            
            // UI ì´ˆê¸°í™”
            loginScreen.style.display = 'block';
            meetingRoom.style.display = 'none';
            remoteVideo.srcObject = null;
            localVideo.srcObject = null;
            messagesLog.innerHTML = '';
            
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ê°€ì¥ ê°„ë‹¨í•œ ì´ˆê¸°í™”)
            window.location.href = window.location.pathname;
        };

        // --- 7. ë¹„ë””ì˜¤ ìœ„ ì»¨íŠ¸ë¡¤ (ìº¡ì²˜, ì „ì²´í™”ë©´) ---
        
        // ì „ì²´í™”ë©´ (ë„¤ì´í‹°ë¸Œ) - ê¸°ëŠ¥ ì œê±°ë¨
        // document.getElementById('local-fullscreen-btn').onclick = () => toggleNativeFullscreen(localVideo);
        // document.getElementById('remote-fullscreen-btn').onclick = () => toggleNativeFullscreen(remoteVideo);

        /*
        function toggleNativeFullscreen(videoElement) {
            if (!document.fullscreenElement) {
                videoElement.requestFullscreen().catch(err => {
                    alert(`ì „ì²´í™”ë©´ ì˜¤ë¥˜: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }
        */

        // ìº¡ì²˜
        document.getElementById('local-capture-btn').onclick = () => captureVideo(localVideo, 'local_capture.png');
        document.getElementById('remote-capture-btn').onclick = () => captureVideo(remoteVideo, 'remote_capture.png');

        function captureVideo(videoElement, filename) {
            if (!videoElement.srcObject) {
                alert("ìº¡ì²˜í•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            const a = document.createElement('a');
            a.href = canvas.toDataURL('image/png');
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        
        // --- 8. ì±„íŒ…ì°½ ë“œë˜ê·¸ ë¡œì§ ---
        
        function makeChatDraggable(isDraggable) {
            if (isDraggable) {
                chatHeader.addEventListener('mousedown', startDrag);
            } else {
                chatHeader.removeEventListener('mousedown', startDrag);
            }
        }

        function startDrag(e) {
            if (!chatContainer.classList.contains('in-theater-mode')) return;
            e.preventDefault();
            // ë·°í¬íŠ¸ ê¸°ì¤€ ì¢Œí‘œë¡œ ê³„ì‚°
            dragOffsetX = e.clientX - chatContainer.getBoundingClientRect().left;
            dragOffsetY = e.clientY - chatContainer.getBoundingClientRect().top;
            document.addEventListener('mousemove', dragChat);
            document.addEventListener('mouseup', stopDrag);
        }

        function dragChat(e) {
            e.preventDefault();
            // ë·°í¬íŠ¸ ê¸°ì¤€ ì¢Œí‘œë¡œ ì„¤ì •
            chatContainer.style.top = (e.clientY - dragOffsetY) + 'px';
            chatContainer.style.left = (e.clientX - dragOffsetX) + 'px';
        }

        function stopDrag() {
            document.removeEventListener('mousemove', dragChat);
            document.removeEventListener('mouseup', stopDrag);
        }
        
        
        // --- 9. íŒì„œ ë„êµ¬ (ìƒˆ ì°½ HTML/CSS/JS) ---
        
        function getWhiteboardHTML() {
            // ìƒˆ ì°½ì— ì‚½ì…ë  HTML, CSS, JS (ë¬¸ìì—´)
            // PDF/Canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í•„ìš”
            
            return \`
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…</title>
    <style>
        body { margin: 0; font-family: 'Inter', 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; background: #fff; }
        #messages-log { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.8rem; background: #f9f9f9; }
        #chat-input-area { display: flex; padding: 1rem; border-top: 1px solid #ecf0f1; background: #fff; }
        #chat-input-area input[type="text"] { flex: 1; border: 1px solid #bdc3c7; border-radius: 20px; padding: 0.7rem 1rem; margin-right: 0.5rem; }
        #chat-input-area button, label { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #7f8c8d; transition: color 0.3s; padding: 0 0.5rem; }
        #chat-input-area button:hover, label:hover { color: #3498db; }
        input[type="file"] { display: none; }
        
        // --- 10. ì±„íŒ… íŒì—… HTML ---
        
        function getChatPopupHTML() {
            return \`
<!DOCTYPE html>
<html lang="ko">
        .message.system { background-color: #f1c40f; color: #333; align-self: center; font-size: 0.9rem; font-style: italic; }
        .message a { color: #fff; font-weight: 600; text-decoration: underline; }
        .message.remote a { color: #2980b9; }
        .message img { max-width: 100%; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="messages-log"></div>
    <div id="chat-input-area">
        <input type="file" id="popup-file-input">
        <label for="popup-file-input" title="íŒŒì¼ ì²¨ë¶€">ğŸ“</label>
        <input type="file" id="popup-image-input" accept="image/*">
        <label for="popup-image-input" title="ì´ë¯¸ì§€ ì²¨ë¶€">ğŸ–¼ï¸</label>
        <input type="text" id="popup-chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
        <button id="popup-send-btn" title="ì „ì†¡">â¤</button>
    </div>
    
    <script>
        const log = document.getElementById('messages-log');
        const input = document.getElementById('popup-chat-input');
        const sendBtn = document.getElementById('popup-send-btn');
        const fileInput = document.getElementById('popup-file-input');
        const imageInput = document.getElementById('popup-image-input');
        
        // 1. ë©”ì¸ ì°½ì—ì„œ í˜¸ì¶œí•  í•¨ìˆ˜ (ë©”ì‹œì§€ ì¶”ê°€)
        function addMessageToPopup(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html.trim();
            const msgElement = tempDiv.firstChild;
            
            // ì´ë¯¸ì§€/ë§í¬ í´ë¦­ ì´ë²¤íŠ¸ ì¬ì—°ê²°
            if (msgElement.querySelector('img')) {
                msgElement.querySelector('img').onclick = () => window.open(msgElement.querySelector('img').src);
            }
            if (msgElement.querySelector('a')) {
                 msgElement.querySelector('a').onclick = (e) => { e.preventDefault(); window.open(msgElement.querySelector('a').href); };
            }
            
            log.appendChild(msgElement);
            log.scrollTop = log.scrollHeight;
        }
        
        // 2. ë©”ì¸ ì°½ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const msg = input.value;
            if (!msg.trim()) return;
            try {
                window.opener.sendChatMessageFromPopup(msg);
                input.value = '';
            } catch(e) { console.error('ë©”ì¸ ì°½ í†µì‹  ì‹¤íŒ¨:', e); }
        }
        
        sendBtn.onclick = sendMessage;
        input.onkeyup = (e) => {
            if (e.key === 'Enter') sendMessage();
        };
        
        // 3. ë©”ì¸ ì°½ìœ¼ë¡œ íŒŒì¼ ì „ì†¡
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    window.opener.sendFileFromPopup(file);
                } catch(e) { console.error('ë©”ì¸ ì°½ í†µì‹  ì‹¤íŒ¨:', e); }
                e.target.value = null;
            }
        };
        
        // 4. ë©”ì¸ ì°½ìœ¼ë¡œ ì´ë¯¸ì§€ ì „ì†¡
        imageInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    window.opener.sendFileFromPopup(file);
                } catch(e) { console.error('ë©”ì¸ ì°½ í†µì‹  ì‹¤íŒ¨:', e); }
                e.target.value = null;
            }
        };

        // 5. ì°½ ë¡œë“œ ì‹œ ë©”ì¸ ì°½ì˜ ê¸°ë¡ ë³µì‚¬
        window.onload = () => {
            try {
                const mainLog = window.opener.document.getElementById('messages-log');
                if (mainLog) {
                    log.innerHTML = mainLog.innerHTML;
                    // ì´ë¯¸ì§€/ë§í¬ í´ë¦­ ì´ë²¤íŠ¸ ì¬ì—°ê²°
                    log.querySelectorAll('img').forEach(img => img.onclick = () => window.open(img.src));
                    log.querySelectorAll('a').forEach(a => a.onclick = (e) => { e.preventDefault(); window.open(a.href); });
                    log.scrollTop = log.scrollHeight;
                }
            } catch(e) { console.error('ë©”ì¸ ì°½ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', e); }
        };
    <\/script>
</body>
</html>
            \`;
        }

    </script>
</body>
</html>
