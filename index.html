<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1:1 í™”ìƒ ì±„íŒ…</title>
    <!-- PeerJS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    
    <!-- íŒì„œ ë„êµ¬ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ (ìƒˆ ì°½ì—ì„œ ë¡œë“œë¨) -->
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #333;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-screen {
            background-color: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 450px;
            box-sizing: border-box;
        }

        #login-screen h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 2rem;
        }

        .login-tabs {
            display: flex;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            background-color: #ecf0f1;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .tab-btn:first-child {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        
        .tab-btn:last-child {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .tab-btn.active {
            background-color: #3498db;
            color: white;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input[type="text"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ */
        }

        .btn {
            width: 100%;
            padding: 0.9rem;
            border: none;
            border-radius: 8px;
            background-color: #3498db;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #2ecc71;
        }
        .btn-secondary:hover {
            background-color: #27ae60;
        }

        #teacher-panel {
            display: none; /* êµì‚¬ ë¹„ë²ˆ ì¸ì¦ í›„ í‘œì‹œ */
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #ecf0f1;
        }

        #shareable-url {
            background-color: #ecf0f1;
            padding: 0.8rem;
            border-radius: 8px;
            word-break: break-all;
            margin-top: 1rem;
        }

        /* íšŒì˜ì‹¤ í™”ë©´ */
        #meeting-room {
            display: none;
            width: 100vw;
            height: 100vh;
            background-color: #2c3e50;
            flex-direction: column;
            overflow: hidden;
        }
        
        #main-content {
            display: flex;
            flex: 1;
            height: calc(100% - 80px); /* ì»¨íŠ¸ë¡¤ ë°” ë†’ì´ ì œì™¸ */
        }

        #video-container {
            flex: 1;
            display: flex;
            flex-direction: row; /* columnì—ì„œ rowë¡œ ë³€ê²½ */
            background-color: #34495e;
            padding: 1rem;
            gap: 1rem;
            box-sizing: border-box;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        
        /* í™•ëŒ€ ëª¨ë“œ (Enlarge) */
        #video-container.theater-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%; /* calc() ì œê±°, ì±„íŒ…ì°½ì€ fixedë¡œ ëœ¸ */
            height: 100vh;
            z-index: 1000;
            padding: 1rem;
            background: #2c3e50;
        }
        
        #video-container.theater-mode #local-video-wrapper {
             flex: 1; /* ë¡œì»¬ ë¹„ë””ì˜¤ê°€ ê½‰ ì°¨ë„ë¡ */
        }
        
        /* #video-container.theater-mode #remote-video-wrapper {
            /* PIPë¡œ ì „í™˜ë˜ë¯€ë¡œ ìˆ¨ê¹€ (PIP APIê°€ ì²˜ë¦¬) */
            /* display: none; */ 
        /* } */


        .video-wrapper {
            position: relative;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            flex: 1; /* ê¸°ë³¸ì ìœ¼ë¡œ 1:1 ë¹„ìœ¨ */
            min-height: 0; /* flexbox ë†’ì´ ë¬¸ì œ í•´ê²° */
        }

        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .video-wrapper:hover .video-controls {
            opacity: 1;
        }

        .video-controls button {
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .video-controls button:hover {
            background: rgba(0,0,0,0.8);
        }

        /* ì±„íŒ…ì°½ (ìš°ì¸¡) */
        #chat-container {
            width: 350px;
            background-color: white;
            display: flex;
            flex-direction: column;
            height: 100%; /* main-content ë†’ì´ì— ë§ì¶¤ */
            border-left: 1px solid #bdc3c7;
            box-sizing: border-box;
            z-index: 1001; /* í™•ëŒ€ ëª¨ë“œë³´ë‹¤ ìœ„ì— */
            transition: width 0.3s ease;
            position: relative; /* ìì‹ ë²„íŠ¼ ìœ„ì¹˜ìš© */
        }
        
        /* í™•ëŒ€ ëª¨ë“œ ì‹œ ì±„íŒ…ì°½ ìŠ¤íƒ€ì¼ */
        #chat-container.in-theater-mode {
            position: fixed;
            top: 1rem;
            right: 1rem;
            height: calc(100vh - 2rem - 80px); /* ìœ„ì•„ë˜ ì—¬ë°±, ì»¨íŠ¸ë¡¤ë°” ë†’ì´ ì œì™¸ */
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-radius: 8px;
            overflow: hidden;
        }
        
        #chat-container.enlarged {
            width: 600px;
        }
        
        #chat-container.hidden {
            display: none;
        }
        
        /* ì±„íŒ…ì°½ ìˆ¨ê²¨ì¡Œì„ ë•Œ ë©”ì¸ ì»¨í…ì¸  ì¡°ì • */
        #main-content.chat-hidden #video-container {
            width: 100%;
        }

        #chat-header {
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
            border-bottom: 1px solid #ecf0f1;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* ë“œë˜ê·¸ ê°€ëŠ¥í•œ í—¤ë” */
        #chat-header.draggable-header {
            cursor: move;
        }
        
        #chat-header-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: #7f8c8d;
            padding: 0 5px;
        }
        #chat-header-buttons button:hover {
            color: #34495e;
        }

        #messages-log {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .message {
            padding: 0.6rem 0.9rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.local {
            background-color: #3498db;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.remote {
            background-color: #ecf0f1;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .message.system {
            background-color: #f1c40f;
            color: #333;
            align-self: center;
            font-size: 0.9rem;
            font-style: italic;
        }
        
        .message a {
            color: #fff;
            font-weight: 600;
            text-decoration: underline;
        }
        
        .message.remote a {
            color: #2980b9;
        }

        #chat-input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #ecf0f1;
        }

        #chat-input-area input[type="text"] {
            flex: 1;
            border: 1px solid #bdc3c7;
            border-radius: 20px;
            padding: 0.7rem 1rem;
            margin-right: 0.5rem;
        }

        #chat-input-area button, #file-input-label {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s;
            padding: 0 0.5rem;
        }
        
        #chat-input-area button:hover, #file-input-label:hover {
            color: #3498db;
        }
        
        #file-input {
            display: none;
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
        #controls-bar {
            height: 80px;
            background-color: #34495e;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 0 1rem;
            box-sizing: border-box;
            border-top: 1px solid #4a6580;
        }

        .control-btn {
            background-color: #5d7ca0;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s;
        }

        .control-btn:hover {
            background-color: #7a9ac4;
        }

        /* ì¼œì§„ ìƒíƒœ (íŒŒë€ìƒ‰) */
        .control-btn.on {
            background-color: #3498db;
        }
        .control-btn.on:hover {
            background-color: #5dade2;
        }

        /* êº¼ì§„ ìƒíƒœ (ë¹¨ê°„ìƒ‰) */
        .control-btn.off {
            background-color: #e74c3c;
        }
        .control-btn.off:hover {
            background-color: #ec7063;
        }
        
        #end-call-btn {
            background-color: #e74c3c;
        }
        #end-call-btn:hover {
            background-color: #c0392b;
        }
        
        /* ì±„íŒ… ë³´ì´ê¸° ë²„íŠ¼ */
        #show-chat-btn {
            position: fixed;
            bottom: 90px; /* ì»¨íŠ¸ë¡¤ ë°” ìœ„ */
            right: 20px;
            z-index: 1002;
            background-color: #3498db;
        }
        #show-chat-btn:hover {
            background-color: #2980b9;
        }
        
        /* ìœ í‹¸ë¦¬í‹° */
        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>

    <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen">
        <h1>í™”ìƒ ì±„íŒ… ì‹œì‘í•˜ê¸°</h1>

        <div class="login-tabs">
            <button class="tab-btn active" onclick="showLoginTab('student')">í•™ìƒ</button>
            <button class="tab-btn" onclick="showLoginTab('teacher')">êµì‚¬</button>
        </div>

        <!-- í•™ìƒ ë¡œê·¸ì¸ í¼ -->
        <div id="student-form" class="login-form active">
            <div class="form-group">
                <label for="student-name">ì´ë¦„</label>
                <input type="text" id="student-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label for="student-meeting-id">í™”ìƒ ID</label>
                <input type="text" id="student-meeting-id" placeholder="êµì‚¬ì—ê²Œ ë°›ì€ ID ì…ë ¥">
            </div>
            <div class="form-group">
                <label for="student-meeting-pass">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="student-meeting-pass" placeholder="íšŒì˜ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            </div>
            <button id="join-btn" class="btn">ì°¸ì—¬í•˜ê¸°</button>
        </div>

        <!-- êµì‚¬ ë¡œê·¸ì¸ í¼ -->
        <div id="teacher-form" class="login-form">
            <div class="form-group">
                <label for="teacher-pass">êµì‚¬ ì¸ì¦</label>
                <input type="password" id="teacher-pass" placeholder="êµì‚¬ ì¸ì¦ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            </div>
            <button id="teacher-auth-btn" class="btn">ì¸ì¦í•˜ê¸°</button>

            <!-- êµì‚¬ ì¸ì¦ í›„ í‘œì‹œë˜ëŠ” íŒ¨ë„ -->
            <div id="teacher-panel">
                <div class="form-group">
                    <label for="teacher-meeting-id">í™”ìƒ ID ì„¤ì •</label>
                    <input type="text" id="teacher-meeting-id" placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±">
                </div>
                <div class="form-group">
                    <label for="teacher-meeting-pass">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</label>
                    <input type="password" id="teacher-meeting-pass" placeholder="í•™ìƒì´ ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸">
                </div>
                <button id="generate-link-btn" class="btn btn-secondary">ê³µìœ  ë§í¬ ìƒì„±</button>
                <div class="form-group" style="margin-top: 1rem;">
                    <label>ê³µìœ ìš© ì£¼ì†Œ:</label>
                    <div id="shareable-url">(ë§í¬ ìƒì„± í›„ í‘œì‹œë©ë‹ˆë‹¤)</div>
                </div>
                <button id="start-teacher-meeting-btn" class="btn hidden" style="margin-top: 1rem;">íšŒì˜ ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- 2. íšŒì˜ì‹¤ í™”ë©´ -->
    <div id="meeting-room">
        <!-- ë©”ì¸ ì»¨í…ì¸  (ë¹„ë””ì˜¤) -->
        <div id="main-content">
            <div id="video-container">
                <!-- ì›ê²© ë¹„ë””ì˜¤ -->
                <div id="remote-video-wrapper" class="video-wrapper">
                    <video id="remote-video" playsinline autoplay></video>
                    <div class="video-controls">
                        <button id="remote-fullscreen-btn" title="ì „ì²´í™”ë©´">FS</button>
                        <button id="remote-capture-btn" title="ìº¡ì²˜">ğŸ“¸</button>
                    </div>
                </div>
                <!-- ë¡œì»¬ ë¹„ë””ì˜¤ -->
                <div id="local-video-wrapper" class="video-wrapper">
                    <video id="local-video" playsinline autoplay muted></video>
                    <div class="video-controls">
                        <button id="local-fullscreen-btn" title="ì „ì²´í™”ë©´">FS</button>
                        <button id="local-capture-btn" title="ìº¡ì²˜">ğŸ“¸</button>
                    </div>
                </div>
            </div>
            
            <!-- ì±„íŒ…ì°½ (ìš°ì¸¡) -->
            <div id="chat-container">
                <div id="chat-header">
                    <span>ì±„íŒ…</span>
                    <div id="chat-header-buttons">
                        <button id="toggle-chat-size-btn" title="í™•ëŒ€/ì¶•ì†Œ">â†”</button>
                        <button id="hide-chat-btn" title="ìˆ¨ê¸°ê¸°">X</button>
                    </div>
                </div>
                <div id="messages-log">
                    <!-- ë©”ì‹œì§€ ë™ì  ì¶”ê°€ -->
                </div>
                <div id="chat-input-area">
                    <input type="file" id="file-input">
                    <label for="file-input" id="file-input-label" title="íŒŒì¼ ì²¨ë¶€">ğŸ“</label>
                    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
                    <button id="send-chat-btn" title="ì „ì†¡">â¤</button>
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” -->
        <div id="controls-bar">
            <button id="mic-btn" class="control-btn on" title="ë§ˆì´í¬ ì¼œê¸°/ë„ê¸°">ğŸ¤</button>
            <button id="video-btn" class="control-btn on" title="ì¹´ë©”ë¼ ì¼œê¸°/ë„ê¸°">ğŸ“·</button>
            <button id="switch-cam-btn" class="control-btn" title="ì¹´ë©”ë¼ ì „í™˜">ğŸ”„</button>
            <button id="share-screen-btn" class="control-btn" title="í™”ë©´ ê³µìœ ">ğŸ–¥ï¸</button>
            <button id="enlarge-btn" class="control-btn" title="í™”ë©´ í™•ëŒ€/PIP">ğŸ”³</button>
            <button id="record-btn" class="control-btn" title="ë…¹í™”">ğŸ”´</button>
            <button id="whiteboard-btn" class="control-btn" title="íŒì„œ">âœï¸</button>
            <button id="end-call-btn" class="control-btn" title="í†µí™” ì¢…ë£Œ">ğŸ“</button>
        </div>
    </div>
    
    <!-- ì±„íŒ… ë³´ì´ê¸° ë²„íŠ¼ (ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
    <button id="show-chat-btn" class="control-btn hidden" title="ì±„íŒ… ë³´ì´ê¸°">ğŸ’¬</button>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let peer;
        let localStream;
        let remoteStream;
        let currentCall;
        let dataConnection;
        let isTeacher = false;
        let currentMeetingId = '';
        let currentMeetingPass = '';
        let myName = '';
        let isMicOn = true;
        let isVideoOn = true;
        let isScreenSharing = false;
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let videoDevices = [];
        let currentVideoDeviceIndex = 0;
        let whiteboardWindow = null;
        
        // íŒŒì¼ ì²­í¬ ê´€ë ¨
        const CHUNK_SIZE = 64 * 1024; // 64KB
        let incomingFileData = {};
        let incomingFileChunks = [];
        let receivedBytes = 0;

        // UI ìš”ì†Œ
        const loginScreen = document.getElementById('login-screen');
        const meetingRoom = document.getElementById('meeting-room');
        const studentForm = document.getElementById('student-form');
        const teacherForm = document.getElementById('teacher-form');
        const teacherPanel = document.getElementById('teacher-panel');

        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const messagesLog = document.getElementById('messages-log');
        const chatInput = document.getElementById('chat-input');
        
        // íšŒì˜ì‹¤ UI ìš”ì†Œ
        const mainContent = document.getElementById('main-content');
        const chatContainer = document.getElementById('chat-container');
        const showChatBtn = document.getElementById('show-chat-btn');
        const chatHeader = document.getElementById('chat-header');
        
        // ì±„íŒ… ë“œë˜ê·¸ ê´€ë ¨ ë³€ìˆ˜
        let dragOffsetX = 0;
        let dragOffsetY = 0;


        // --- 1. ë¡œê·¸ì¸ ë° ì´ˆê¸°í™” ë¡œì§ ---

        // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° í™•ì¸
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const pass = urlParams.get('pass');

            if (id && pass) {
                // í•™ìƒ URL ì ‘ì†
                document.getElementById('student-meeting-id').value = id;
                document.getElementById('student-meeting-pass').value = pass;
                document.getElementById('student-meeting-pass').disabled = true; // ë¹„ë²ˆ ì…ë ¥ ë°©ì§€
                showLoginTab('student');
            }
        };

        // íƒ­ ì „í™˜
        function showLoginTab(role) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(form => form.classList.remove('active'));
            
            document.querySelector(`.tab-btn[onclick="showLoginTab('${role}')"]`).classList.add('active');
            document.getElementById(`${role}-form`).classList.add('active');
        }

        // êµì‚¬ ì¸ì¦
        document.getElementById('teacher-auth-btn').onclick = () => {
            const pass = document.getElementById('teacher-pass').value;
            if (pass === 'a123456!') {
                teacherPanel.style.display = 'block';
                // ID ìƒì„± ë¡œì§ì„ 'ê³µìœ  ë§í¬ ìƒì„±' ë²„íŠ¼ìœ¼ë¡œ ì´ë™
                isTeacher = true;
                myName = 'êµì‚¬';
            } else {
                alert('êµì‚¬ ì¸ì¦ ì‹¤íŒ¨!');
            }
        };

        // êµì‚¬: íšŒì˜ ìƒì„±
        document.getElementById('generate-link-btn').onclick = () => {
            currentMeetingPass = document.getElementById('teacher-meeting-pass').value;
            if (!currentMeetingPass) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”.');
                return;
            }
            
            // í™”ìƒ ID ì„¤ì • (ìˆ˜ë™ ë˜ëŠ” ìë™)
            let manualMeetingId = document.getElementById('teacher-meeting-id').value.trim();
            if (manualMeetingId) {
                currentMeetingId = manualMeetingId;
            } else {
                currentMeetingId = 'teacher-' + Math.random().toString(36).substr(2, 9);
                document.getElementById('teacher-meeting-id').value = currentMeetingId; // ìë™ ìƒì„±ëœ ID í‘œì‹œ
            }
            
            // ê³µìœ  URL ìƒì„±
            const url = `${window.location.origin}${window.location.pathname}?id=${currentMeetingId}&pass=${currentMeetingPass}`;
            document.getElementById('shareable-url').textContent = url;
            
            // 'íšŒì˜ ì‹œì‘í•˜ê¸°' ë²„íŠ¼ í‘œì‹œ
            document.getElementById('start-teacher-meeting-btn').classList.remove('hidden');
            // startMeeting(); // -> ì‹œì‘ ë²„íŠ¼ìœ¼ë¡œ ì´ë™
        };
        
        // êµì‚¬: íšŒì˜ ì‹œì‘
        document.getElementById('start-teacher-meeting-btn').onclick = startMeeting;

        // í•™ìƒ: íšŒì˜ ì°¸ì—¬
        document.getElementById('join-btn').onclick = () => {
            myName = document.getElementById('student-name').value;
            currentMeetingId = document.getElementById('student-meeting-id').value;
            currentMeetingPass = document.getElementById('student-meeting-pass').value;
            
            if (!myName || !currentMeetingId || !currentMeetingPass) {
                alert('ì´ë¦„, ID, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            isTeacher = false;
            startMeeting();
        };

        // --- 2. ë¯¸ë””ì–´ ë° PeerJS ì‹œì‘ ---

        async function startMeeting() {
            try {
                // 1. ë¡œì»¬ ë¯¸ë””ì–´ ì‹œì‘
                await startLocalMedia();
                
                // 2. PeerJS ì´ˆê¸°í™”
                initializePeer();
                
                // 3. UI ì „í™˜
                loginScreen.style.display = 'none';
                meetingRoom.style.display = 'flex';

            } catch (err) {
                console.error("ë¯¸ë””ì–´ ì‹œì‘ ì‹¤íŒ¨:", err);
                alert("ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        }

        async function startLocalMedia(videoDeviceId = undefined) {
            // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                audio: true,
                video: {
                    facingMode: 'user', // ê¸°ë³¸ ì „ë©´ ì¹´ë©”ë¼
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            // íŠ¹ì • ì¹´ë©”ë¼ ì¥ì¹˜ IDê°€ ìˆìœ¼ë©´ ì‚¬ìš© (ì¹´ë©”ë¼ ì „í™˜ ì‹œ)
            if (videoDeviceId) {
                constraints.video.deviceId = { exact: videoDeviceId };
            }

            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            localVideo.srcObject = localStream;
            
            // ë¹„ë””ì˜¤ ì¥ì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (íƒœë¸”ë¦¿ ë“± ì§€ì›)
            getVideoDevices();
            
            // PeerJS ì—°ê²°ì´ ì´ë¯¸ ìˆìœ¼ë©´ íŠ¸ë™ êµì²´
            if (currentCall) {
                const videoTrack = localStream.getVideoTracks()[0];
                const audioTrack = localStream.getAudioTracks()[0];
                
                currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video').replaceTrack(videoTrack);
                currentCall.peerConnection.getSenders().find(s => s.track.kind === 'audio').replaceTrack(audioTrack);
            }
        }
        
        // ë¹„ë””ì˜¤ ì¥ì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function getVideoDevices() {
             try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(device => device.kind === 'videoinput');
                // console.log("ë¹„ë””ì˜¤ ì¥ì¹˜:", videoDevices);
                document.getElementById('switch-cam-btn').classList.toggle('hidden', videoDevices.length <= 1);
            } catch (e) {
                console.error("ì¥ì¹˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", e);
            }
        }

        function initializePeer() {
            if (isTeacher) {
                peer = new Peer(currentMeetingId); // êµì‚¬ëŠ” ì§€ì •ëœ ID ì‚¬ìš©
            } else {
                peer = new Peer(); // í•™ìƒì€ ëœë¤ ID ì‚¬ìš©
            }

            peer.on('open', id => {
                console.log('PeerJS ID:', id);
                if (!isTeacher) {
                    // í•™ìƒì€ êµì‚¬ì—ê²Œ ë°ì´í„° ì—°ê²° ë° í†µí™” ìš”ì²­
                    connectToTeacher();
                }
            });

            // êµì‚¬: í•™ìƒì˜ ë°ì´í„° ì—°ê²° ìˆ˜ì‹ 
            peer.on('connection', conn => {
                console.log('ë°ì´í„° ì—°ê²° ìˆ˜ì‹ :', conn.peer);
                setupDataConnection(conn);
            });

            // êµì‚¬: í•™ìƒì˜ ì˜ìƒ í†µí™” ìˆ˜ì‹ 
            peer.on('call', call => {
                console.log('ì˜ìƒ í†µí™” ìˆ˜ì‹ :', call.peer);
                
                // êµì‚¬ ì¸¡ì—ì„œë§Œ answer (í•™ìƒì€ callë§Œ í•¨)
                // -> ìˆ˜ì •: êµì‚¬ê°€ í•™ìƒì˜ pwë¥¼ í™•ì¸í•œ í›„ì—ë§Œ answer
                // -> ìˆ˜ì •2: í•™ìƒì´ ë°ì´í„° ì—°ê²°ë¡œ pw ì „ì†¡ -> êµì‚¬ê°€ í™•ì¸ -> êµì‚¬ê°€ call
                
                // í•™ìƒì´ ë³´ë‚¸ í†µí™” ìš”ì²­ ì‘ë‹µ
                call.answer(localStream);
                setupCall(call);
            });
            
            peer.on('error', err => {
                console.error("PeerJS ì˜¤ë¥˜:", err);
                // alert("ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            });
        }
        
        // í•™ìƒ: êµì‚¬ì—ê²Œ ì—°ê²°
        function connectToTeacher() {
            // 1. ë°ì´í„° ì—°ê²° (ì¸ì¦ìš©)
            console.log(`êµì‚¬(${currentMeetingId})ì—ê²Œ ë°ì´í„° ì—°ê²° ì‹œë„...`);
            dataConnection = peer.connect(currentMeetingId, {
                metadata: { 
                    name: myName, 
                    pass: currentMeetingPass 
                }
            });
            setupDataConnection(dataConnection);

            // 2. ì˜ìƒ í†µí™” (ë°ì´í„° ì—°ê²° ì„±ê³µ í›„ êµì‚¬ê°€ ê±¸ë„ë¡ ìˆ˜ì •)
            // console.log(`êµì‚¬(${currentMeetingId})ì—ê²Œ ì˜ìƒ í†µí™” ì‹œë„...`);
            // currentCall = peer.call(currentMeetingId, localStream);
            // setupCall(currentCall);
        }
        
        // --- 3. ë°ì´í„° ì±„ë„ (ì±„íŒ…, íŒŒì¼, ì¸ì¦) ---

        function setupDataConnection(conn) {
            dataConnection = conn;
            
            dataConnection.on('open', () => {
                console.log('ë°ì´í„° ì±„ë„ ì—´ë¦¼:', dataConnection.peer);
                if (isTeacher) {
                    // êµì‚¬: í•™ìƒ ì¸ì¦ í™•ì¸
                    const metadata = dataConnection.metadata;
                    if (metadata.pass === currentMeetingPass) {
                        console.log(`í•™ìƒ(${metadata.name}) ì¸ì¦ ì„±ê³µ`);
                        // ì¸ì¦ ì„±ê³µ ë©”ì‹œì§€ ì „ì†¡
                        dataConnection.send({ type: 'auth_success' });
                        addChatMessage(`'${metadata.name}'ë‹˜ì´ ì ‘ì†í–ˆìŠµë‹ˆë‹¤.`, 'system');
                        
                        // ì¸ì¦ ì„±ê³µ í›„ êµì‚¬ê°€ í•™ìƒì—ê²Œ ì˜ìƒ í†µí™” ì‹œì‘
                        console.log(`í•™ìƒ(${dataConnection.peer})ì—ê²Œ ì˜ìƒ í†µí™” ì‹œë„...`);
                        currentCall = peer.call(dataConnection.peer, localStream);
                        setupCall(currentCall);

                    } else {
                        console.log(`í•™ìƒ(${metadata.name}) ì¸ì¦ ì‹¤íŒ¨`);
                        dataConnection.send({ type: 'auth_fail' });
                        dataConnection.close();
                    }
                } else {
                     // í•™ìƒ: ì—°ê²° ì„±ê³µ (ì¸ì¦ ëŒ€ê¸°)
                     console.log('êµì‚¬ì—ê²Œ ë°ì´í„° ì—°ê²° ì„±ê³µ. ì¸ì¦ ëŒ€ê¸° ì¤‘...');
                }
            });

            dataConnection.on('data', data => {
                // console.log("ë°ì´í„° ìˆ˜ì‹ :", data.type);
                switch(data.type) {
                    case 'auth_success': // í•™ìƒì´ ë°›ìŒ
                        console.log("êµì‚¬ ì¸ì¦ ì„±ê³µ!");
                        addChatMessage("ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.", 'system');
                        break;
                    case 'auth_fail': // í•™ìƒì´ ë°›ìŒ
                        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ì—°ê²°ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        peer.destroy();
                        location.reload();
                        break;
                    case 'chat':
                        addChatMessage(data.message, 'remote');
                        break;
                    case 'file_meta': // íŒŒì¼ ì „ì†¡ ì‹œì‘ (ë©”íƒ€ë°ì´í„°)
                        incomingFileData = {
                            name: data.name,
                            size: data.size,
                            type: data.type
                        };
                        incomingFileChunks = [];
                        receivedBytes = 0;
                        addChatMessage(`íŒŒì¼ ìˆ˜ì‹  ì¤‘: ${data.name} (${(data.size / 1024 / 1024).toFixed(2)} MB)`, 'system');
                        break;
                    case 'file_chunk': // íŒŒì¼ ì¡°ê° (ì²­í¬)
                        incomingFileChunks.push(data.chunk);
                        receivedBytes += data.chunk.byteLength;
                        
                        // ì§„í–‰ë¥  í‘œì‹œ (ì˜µì…˜)
                        // console.log(`ìˆ˜ì‹  ì§„í–‰: ${(receivedBytes / incomingFileData.size * 100).toFixed(1)}%`);
                        
                        // ëª¨ë“  ì²­í¬ë¥¼ ë°›ìœ¼ë©´ íŒŒì¼ ì¬ì¡°ë¦½
                        if (receivedBytes === incomingFileData.size) {
                            reassembleFile();
                        }
                        break;
                    // case 'file_end': // íŒŒì¼ ì „ì†¡ ì™„ë£Œ (ì²­í¬ í¬ê¸°ë¡œ ëŒ€ì²´)
                    //     reassembleFile();
                    //     break;
                }
            });
            
            dataConnection.on('close', () => {
                addChatMessage('ìƒëŒ€ë°©ì´ ì—°ê²°ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.', 'system');
                remoteVideo.srcObject = null;
                if(currentCall) currentCall.close();
            });
        }
        
        // íŒŒì¼ ì¬ì¡°ë¦½ ë° ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
        function reassembleFile() {
            try {
                const fileBlob = new Blob(incomingFileChunks, { type: incomingFileData.type });
                const url = URL.createObjectURL(fileBlob);
                
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', 'remote');
                
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = incomingFileData.name;
                downloadLink.textContent = `[íŒŒì¼ ë‹¤ìš´ë¡œë“œ] ${incomingFileData.name}`;
                
                messageDiv.appendChild(downloadLink);
                messagesLog.appendChild(messageDiv);
                messagesLog.scrollTop = messagesLog.scrollHeight;
                
                // ì´ˆê¸°í™”
                incomingFileData = {};
                incomingFileChunks = [];
                receivedBytes = 0;

            } catch (e) {
                console.error("íŒŒì¼ ì¬ì¡°ë¦½ ì‹¤íŒ¨:", e);
                addChatMessage(`íŒŒì¼ ìˆ˜ì‹  ì‹¤íŒ¨: ${incomingFileData.name}`, 'system');
            }
        }

        // --- 4. ì˜ìƒ/ìŒì„± í†µí™” ì„¤ì • ---

        function setupCall(call) {
            currentCall = call;
            
            // ìƒëŒ€ë°© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ 
            call.on('stream', stream => {
                console.log('ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ ');
                remoteStream = stream;
                remoteVideo.srcObject = stream;
                addChatMessage("í™”ìƒ ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", 'system');
            });

            call.on('close', () => {
                console.log('í†µí™” ì¢…ë£Œ');
                remoteVideo.srcObject = null;
                addChatMessage('ìƒëŒ€ë°©ì´ í†µí™”ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.', 'system');
            });
            
            call.on('error', err => {
                console.error("í†µí™” ì˜¤ë¥˜:", err);
            });
        }
        
        // --- 5. ì±„íŒ… ë° íŒŒì¼ ì „ì†¡ UI ---
        
        // ì±„íŒ…ì°½ ì œì–´
        document.getElementById('toggle-chat-size-btn').onclick = () => {
            chatContainer.classList.toggle('enlarged');
        };
        
        document.getElementById('hide-chat-btn').onclick = () => {
            chatContainer.classList.add('hidden');
            mainContent.classList.add('chat-hidden');
            showChatBtn.classList.remove('hidden');
        };
        
        document.getElementById('show-chat-btn').onclick = () => {
            chatContainer.classList.remove('hidden');
            mainContent.classList.remove('chat-hidden');
            showChatBtn.classList.add('hidden');
        };
        
        // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('send-chat-btn').onclick = sendChatMessage;
        chatInput.onkeyup = (e) => {
            if (e.key === 'Enter') sendChatMessage();
        };

        function sendChatMessage() {
            const message = chatInput.value;
            if (!message.trim() || !dataConnection) return;
            
            dataConnection.send({ type: 'chat', message: message });
            addChatMessage(message, 'local');
            chatInput.value = '';
        }

        // ì±„íŒ… ë©”ì‹œì§€ UIì— ì¶”ê°€
        function addChatMessage(message, type) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', type);
            msgDiv.textContent = message; // textContentë¡œ XSS ë°©ì§€
            messagesLog.appendChild(msgDiv);
            messagesLog.scrollTop = messagesLog.scrollHeight;
        }

        // íŒŒì¼ ì „ì†¡ (ë¡œì§ ë¶„ë¦¬)
        function sendFile(file) {
            if (!file || !dataConnection) {
                if (!dataConnection) alert("ì±„íŒ…ì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            // 100MB ì œí•œ (ì•½ 100 * 1024 * 1024)
            if (file.size > 104857600) {
                 addChatMessage(`íŒŒì¼ í¬ê¸°ê°€ 100MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. (í¬ê¸°: ${(file.size / 1024 / 1024).toFixed(1)}MB)`, 'system');
                 return;
            }
            
            addChatMessage(`íŒŒì¼ ì „ì†¡ ì¤‘: ${file.name}`, 'local');
            
            // 1. ë©”íƒ€ë°ì´í„° ì „ì†¡
            dataConnection.send({
                type: 'file_meta',
                name: file.name,
                size: file.size,
                type: file.type
            });

            // 2. íŒŒì¼ ì²­í¬ ì „ì†¡
            const reader = new new FileReader();
            reader.onload = (event) => {
                const buffer = event.target.result;
                let offset = 0;

                const sendNextChunk = () => {
                    if (offset >= buffer.byteLength) {
                        // console.log("íŒŒì¼ ì „ì†¡ ì™„ë£Œ:", file.name);
                        return;
                    }
                    
                    if (dataConnection.dataChannel.bufferedAmount > dataConnection.dataChannel.bufferedAmountLowThreshold) {
                        setTimeout(sendNextChunk, 100); // ì ì‹œ ëŒ€ê¸°
                        return;
                    }

                    const chunk = buffer.slice(offset, offset + CHUNK_SIZE);
                    dataConnection.send({ type: 'file_chunk', chunk: chunk });
                    offset += chunk.byteLength;
                    
                    setTimeout(sendNextChunk, 0); 
                };
                
                sendNextChunk();
            };
            reader.readAsArrayBuffer(file);
        }
        
        // íŒŒì¼ ì…ë ¥(input) ë³€ê²½ ì‹œ
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            sendFile(file);
            e.target.value = null; // ë™ì¼ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡
        };
        
        // íŒì„œ ë„êµ¬ì—ì„œ í˜¸ì¶œí•  ìº¡ì²˜ ì „ì†¡ í•¨ìˆ˜
        function sendWhiteboardCapture(dataUrl) {
            if (!dataConnection) {
                alert("ì±„íŒ…ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }
            
            // DataURLì„ Blob -> File ê°ì²´ë¡œ ë³€í™˜
            fetch(dataUrl)
                .then(res => res.blob())
                .then(blob => {
                    const filename = `whiteboard_capture_${new Date().toISOString().split('T')[0]}.png`;
                    const file = new File([blob], filename, { type: 'image/png' });
                    // ë¶„ë¦¬ëœ sendFile í•¨ìˆ˜ í˜¸ì¶œ
                    sendFile(file);
                });
        }


        // --- 6. í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ---

        // ë§ˆì´í¬ ì¼œê¸°/ë„ê¸°
        document.getElementById('mic-btn').onclick = () => {
            if (!localStream) return;
            isMicOn = !isMicOn;
            localStream.getAudioTracks()[0].enabled = isMicOn;
            
            const btn = document.getElementById('mic-btn');
            btn.classList.toggle('on', isMicOn);
            btn.classList.toggle('off', !isMicOn);
            btn.innerHTML = isMicOn ? 'ğŸ¤' : 'ğŸ”‡';
        };

        // ì¹´ë©”ë¼ ì¼œê¸°/ë„ê¸°
        document.getElementById('video-btn').onclick = () => {
            if (!localStream) return;
            isVideoOn = !isVideoOn;
            localStream.getVideoTracks()[0].enabled = isVideoOn;
            
            const btn = document.getElementById('video-btn');
            btn.classList.toggle('on', isVideoOn);
            btn.classList.toggle('off', !isVideoOn);
            btn.innerHTML = isVideoOn ? 'ğŸ“·' : 'ğŸš«';
        };

        // ì¹´ë©”ë¼ ì „í™˜
        document.getElementById('switch-cam-btn').onclick = async () => {
            if (videoDevices.length > 1 && !isScreenSharing) {
                currentVideoDeviceIndex = (currentVideoDeviceIndex + 1) % videoDevices.length;
                const newVideoId = videoDevices[currentVideoDeviceIndex].deviceId;
                await startLocalMedia(newVideoId); // ìƒˆ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ êµì²´
            } else if (isScreenSharing) {
                // í™”ë©´ ê³µìœ  ì¤‘ì§€ (ì¹´ë©”ë¼ë¡œ ë³µê·€)
                await startLocalMedia(videoDevices[currentVideoDeviceIndex]?.deviceId);
                isScreenSharing = false;
                document.getElementById('share-screen-btn').classList.remove('on');
            }
        };

        // í™”ë©´ ê³µìœ 
        document.getElementById('share-screen-btn').onclick = async () => {
            if (isScreenSharing) {
                // í™”ë©´ ê³µìœ  ì¤‘ì§€ (ì¹´ë©”ë¼ë¡œ ë³µê·€)
                await startLocalMedia(videoDevices[currentVideoDeviceIndex]?.deviceId);
                isScreenSharing = false;
                document.getElementById('share-screen-btn').classList.remove('on');
                document.getElementById('switch-cam-btn').classList.toggle('hidden', videoDevices.length <= 1);
            } else {
                // í™”ë©´ ê³µìœ  ì‹œì‘
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true // ì‹œìŠ¤í…œ ì˜¤ë””ì˜¤ ê³µìœ  ì‹œë„
                    });
                    
                    // í™”ë©´ ê³µìœ  ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ êµì²´
                    const screenVideoTrack = screenStream.getVideoTracks()[0];
                    const screenAudioTrack = screenStream.getAudioTracks()[0];
                    
                    if (currentCall) {
                        currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video').replaceTrack(screenVideoTrack);
                        if (screenAudioTrack) {
                             currentCall.peerConnection.getSenders().find(s => s.track.kind === 'audio').replaceTrack(screenAudioTrack);
                        }
                    }
                    
                    // ë¡œì»¬ ë¹„ë””ì˜¤ë„ í™”ë©´ ê³µìœ ë¡œ ë³€ê²½ (ì„ íƒ ì‚¬í•­)
                    localVideo.srcObject = screenStream;
                    localStream = screenStream; // ë¡œì»¬ ìŠ¤íŠ¸ë¦¼ì„ í™”ë©´ ê³µìœ ë¡œ êµì²´
                    
                    isScreenSharing = true;
                    document.getElementById('share-screen-btn').classList.add('on');
                    document.getElementById('switch-cam-btn').classList.remove('hidden'); // ë³µê·€ ë²„íŠ¼ìœ¼ë¡œ í™œì„±í™”

                    // í™”ë©´ ê³µìœ  ì¤‘ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ ì›ë˜ ì¹´ë©”ë¼ë¡œ ë³µê·€
                    screenVideoTrack.onended = () => {
                        if (isScreenSharing) { // ì‚¬ìš©ìê°€ ìˆ˜ë™ ì¤‘ì§€ ì•ˆí–ˆì„ ë•Œë§Œ
                            document.getElementById('share-screen-btn').click();
                        }
                    };

                } catch (err) {
                    console.error("í™”ë©´ ê³µìœ  ì‹¤íŒ¨:", err);
                }
            }
        };

        // í™”ë©´ í™•ëŒ€ (Theater Mode) / PIP
        document.getElementById('enlarge-btn').onclick = async () => {
            const btn = document.getElementById('enlarge-btn');
            videoContainer.classList.toggle('theater-mode');
            chatContainer.classList.toggle('in-theater-mode');
            
            if (videoContainer.classList.contains('theater-mode')) {
                // í™•ëŒ€ ëª¨ë“œ
                btn.innerHTML = 'â†™ï¸'; // ì¶•ì†Œ ì•„ì´ì½˜
                chatHeader.classList.add('draggable-header');
                makeChatDraggable(true);
                
                // ì›ê²© ë¹„ë””ì˜¤ë¥¼ PIPë¡œ
                if (remoteVideo.srcObject && document.pictureInPictureEnabled) {
                    try {
                        await remoteVideo.requestPictureInPicture();
                    } catch (err) {
                        console.error("PIP ì‹œì‘ ì‹¤íŒ¨:", err);
                    }
                }
            } else {
                // ì¶•ì†Œ ëª¨ë“œ
                btn.innerHTML = 'ğŸ”³'; // í™•ëŒ€ ì•„ì´ì½˜
                chatHeader.classList.remove('draggable-header');
                makeChatDraggable(false);
                
                // ë“œë˜ê·¸ë¡œ ë³€ê²½ëœ ìœ„ì¹˜ ì´ˆê¸°í™”
                chatContainer.style.top = '';
                chatContainer.style.left = '';
                
                // PIP ì¢…ë£Œ
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                }
            }
        };

        // ë…¹í™”
        document.getElementById('record-btn').onclick = () => {
            if (!remoteStream) {
                alert("ìƒëŒ€ë°©ì˜ ì˜ìƒì´ ì—°ê²°ë˜ì§€ ì•Šì•„ ë…¹í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            const btn = document.getElementById('record-btn');
            if (isRecording) {
                // ë…¹í™” ì¤‘ì§€
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('off'); // ë¹¨ê°„ìƒ‰ ì¤‘ì§€
                btn.innerHTML = 'ğŸ”´';
            } else {
                // ë…¹í™” ì‹œì‘
                recordedChunks = [];
                
                // (ê³ ê¸‰: ë¡œì»¬ê³¼ ì›ê²©ì„ í•©ì¹˜ë ¤ë©´ Canvasì— ê·¸ë ¤ì•¼ í•¨)
                // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ê²Œ ì›ê²© ìŠ¤íŠ¸ë¦¼ë§Œ ë…¹í™”
                const options = { mimeType: 'video/webm; codecs=vp9' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                     options.mimeType = 'video/webm; codecs=vp8';
                     if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                         options.mimeType = 'video/webm';
                     }
                }
                
                mediaRecorder = new MediaRecorder(remoteStream, options);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `recording_${new Date().toISOString()}.webm`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                };

                mediaRecorder.start();
                isRecording = true;
                btn.classList.add('off'); // ë…¹í™” ì¤‘ (ë¹¨ê°„ìƒ‰)
                btn.innerHTML = 'â– ';
            }
        };

        // íŒì„œ (ìƒˆ ì°½)
        document.getElementById('whiteboard-btn').onclick = () => {
            if (whiteboardWindow && !whiteboardWindow.closed) {
                whiteboardWindow.focus();
            } else {
                whiteboardWindow = window.open('', 'Whiteboard', 'width=1000,height=700,menubar=no,toolbar=no');
                whiteboardWindow.document.write(getWhiteboardHTML());
                whiteboardWindow.document.close();
            }
        };
        
        // í†µí™” ì¢…ë£Œ
        document.getElementById('end-call-btn').onclick = () => {
            if (peer) {
                peer.destroy(); // PeerJS ì—°ê²° ì™„ì „ ì¢…ë£Œ
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            if(whiteboardWindow && !whiteboardWindow.closed) {
                whiteboardWindow.close();
            }
            
            // UI ì´ˆê¸°í™”
            loginScreen.style.display = 'block';
            meetingRoom.style.display = 'none';
            remoteVideo.srcObject = null;
            localVideo.srcObject = null;
            messagesLog.innerHTML = '';
            
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ê°€ì¥ ê°„ë‹¨í•œ ì´ˆê¸°í™”)
            window.location.href = window.location.pathname;
        };

        // --- 7. ë¹„ë””ì˜¤ ìœ„ ì»¨íŠ¸ë¡¤ (ìº¡ì²˜, ì „ì²´í™”ë©´) ---
        
        // ì „ì²´í™”ë©´ (ë„¤ì´í‹°ë¸Œ)
        document.getElementById('local-fullscreen-btn').onclick = () => toggleNativeFullscreen(localVideo);
        document.getElementById('remote-fullscreen-btn').onclick = () => toggleNativeFullscreen(remoteVideo);

        function toggleNativeFullscreen(videoElement) {
            if (!document.fullscreenElement) {
                videoElement.requestFullscreen().catch(err => {
                    alert(`ì „ì²´í™”ë©´ ì˜¤ë¥˜: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // ìº¡ì²˜
        document.getElementById('local-capture-btn').onclick = () => captureVideo(localVideo, 'local_capture.png');
        document.getElementById('remote-capture-btn').onclick = () => captureVideo(remoteVideo, 'remote_capture.png');

        function captureVideo(videoElement, filename) {
            if (!videoElement.srcObject) {
                alert("ìº¡ì²˜í•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            const a = document.createElement('a');
            a.href = canvas.toDataURL('image/png');
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        
        // --- 8. ì±„íŒ…ì°½ ë“œë˜ê·¸ ë¡œì§ ---
        
        function makeChatDraggable(isDraggable) {
            if (isDraggable) {
                chatHeader.addEventListener('mousedown', startDrag);
            } else {
                chatHeader.removeEventListener('mousedown', startDrag);
            }
        }

        function startDrag(e) {
            if (!chatContainer.classList.contains('in-theater-mode')) return;
            e.preventDefault();
            // ë·°í¬íŠ¸ ê¸°ì¤€ ì¢Œí‘œë¡œ ê³„ì‚°
            dragOffsetX = e.clientX - chatContainer.getBoundingClientRect().left;
            dragOffsetY = e.clientY - chatContainer.getBoundingClientRect().top;
            document.addEventListener('mousemove', dragChat);
            document.addEventListener('mouseup', stopDrag);
        }

        function dragChat(e) {
            e.preventDefault();
            // ë·°í¬íŠ¸ ê¸°ì¤€ ì¢Œí‘œë¡œ ì„¤ì •
            chatContainer.style.top = (e.clientY - dragOffsetY) + 'px';
            chatContainer.style.left = (e.clientX - dragOffsetX) + 'px';
        }

        function stopDrag() {
            document.removeEventListener('mousemove', dragChat);
            document.removeEventListener('mouseup', stopDrag);
        }
        
        
        // --- 9. íŒì„œ ë„êµ¬ (ìƒˆ ì°½ HTML/CSS/JS) ---
        
        function getWhiteboardHTML() {
            // ìƒˆ ì°½ì— ì‚½ì…ë  HTML, CSS, JS (ë¬¸ìì—´)
            // PDF/Canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í•„ìš”
            
            return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íŒì„œ ë„êµ¬</title>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"><\/script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f0f0; display: flex; }
        #toolbar { 
            width: 200px; background: #fff; padding: 1rem; box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; gap: 1rem;
        }
        .tool-group { border-bottom: 1px solid #eee; padding-bottom: 1rem; }
        .tool-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .tool-group input, .tool-group button, .tool-group select { width: 100%; box-sizing: border-box; padding: 5px; }
        .tool-group button { background: #3498db; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 5px; }
        .tool-group button:hover { background: #2980b9; }
        .tool-group button.warning { background: #e74c3c; }
        .tool-group button.warning:hover { background: #c0392b; }
        
        #canvas-container { flex: 1; padding: 1rem; position: relative; }
        #whiteboard { 
            background: #fff; 
            border: 1px solid #ccc; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            cursor: crosshair;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }
        #page-nav { text-align: center; margin-top: 5px; font-size: 1.1rem; }
    </style>
</head>
<body>
    <div id="toolbar">
        <div class="tool-group">
            <label>ë„êµ¬</label>
            <button id="pen-btn" style="background: #2ecc71;">íœ</button>
            <button id="highlighter-btn">í˜•ê´‘íœ</button>
            <button id="eraser-btn">ì§€ìš°ê°œ</button>
        </div>
        <div class="tool-group">
            <label for="color-picker">ìƒ‰ìƒ</label>
            <input type="color" id="color-picker" value="#000000">
        </div>
        <div class="tool-group">
            <label for="size-slider">êµµê¸° (<span id="size-value">5</span>px)</label>
            <input type="range" id="size-slider" min="1" max="50" value="5">
        </div>
        <div class="tool-group">
            <label>í˜ì´ì§€</label>
            <button id="prev-page-btn">ì´ì „</button>
            <span id="page-display" style="display: block; text-align: center; padding: 5px;">1 / 1</span>
            <button id="next-page-btn">ë‹¤ìŒ</button>
            <button id="add-page-btn" style="background: #9b59b6; margin-top: 5px;">í˜ì´ì§€ ì¶”ê°€</button>
        </div>
        <div class="tool-group">
            <label>ê´€ë¦¬</label>
            <button id="clear-all-btn" class="warning">ëª¨ë‘ ì§€ìš°ê¸°</button>
        </div>
        <div class="tool-group">
            <label>ì €ì¥</label>
            <button id="save-png-btn">í˜„ì¬ í˜ì´ì§€ (PNG)</button>
            <button id="save-pdf-btn">í˜„ì¬ í˜ì´ì§€ (PDF)</button>
            <button id="save-all-pdf-btn">ëª¨ë“  í˜ì´ì§€ (PDF)</button>
            <button id="send-chat-btn" style="background: #f39c12; margin-top: 5px;">ì±„íŒ…ì— ì „ì†¡</button>
        </div>
    </div>
    <div id="canvas-container">
        <canvas id="whiteboard"></canvas>
    </div>

    <script>
        // PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
        const { jsPDF } = window.jspdf;

        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('canvas-container');
        
        let isDrawing = false;
        let isEraser = false;
        let isHighlighter = false;
        let currentColor = '#000000';
        let currentSize = 5;
        
        let pages = []; // ê° í˜ì´ì§€ì˜ canvas ë°ì´í„°ë¥¼ ì €ì¥
        let currentPageIndex = 0;

        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            // ë¦¬ì‚¬ì´ì¦ˆ í›„ í˜„ì¬ í˜ì´ì§€ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            loadPage(currentPageIndex);
        }
        
        window.onresize = resizeCanvas;

        // ê·¸ë¦¬ê¸°
        function startDrawing(e) {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            
            if (isEraser) {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.globalAlpha = 1.0;
            } else if (isHighlighter) {
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 0.3; // í˜•ê´‘íœ íˆ¬ëª…ë„
            } else { // íœ
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1.0;
            }
            
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }

        function stopDrawing() {
            if (!isDrawing) return;
            ctx.closePath();
            isDrawing = false;
            // í˜„ì¬ ìº”ë²„ìŠ¤ ìƒíƒœ ì €ì¥
            savePage(currentPageIndex);
        }
        
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // --- ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€ ---
        function getTouchPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.touches[0].clientX - rect.left,
                y: e.touches[0].clientY - rect.top
            };
        }
        
        canvas.addEventListener('touchstart', (e) => {
            if (e.target == canvas) {
                e.preventDefault();
                const pos = getTouchPos(e);
                startDrawing({ offsetX: pos.x, offsetY: pos.y });
            }
        }, { passive: false });
        
        canvas.addEventListener('touchmove', (e) => {
            if (e.target == canvas) {
                e.preventDefault();
                const pos = getTouchPos(e);
                draw({ offsetX: pos.x, offsetY: pos.y });
            }
        }, { passive: false });
        
        canvas.addEventListener('touchend', (e) => {
            if (e.target == canvas) {
                e.preventDefault();
                stopDrawing();
            }
        }, { passive: false });
        
        // --- íˆ´ë°” ë¡œì§ ---
        document.getElementById('pen-btn').onclick = () => { 
            isEraser = false; 
            isHighlighter = false; 
        };
        document.getElementById('highlighter-btn').onclick = () => { 
            isEraser = false; 
            isHighlighter = true; 
        };
        document.getElementById('eraser-btn').onclick = () => { 
            isEraser = true; 
            isHighlighter = false; 
        };
        
        const colorPicker = document.getElementById('color-picker');
        colorPicker.oninput = (e) => { currentColor = e.target.value; }; // onchange -> oninput
        
        const sizeSlider = document.getElementById('size-slider');
        const sizeValue = document.getElementById('size-value');
        sizeSlider.oninput = (e) => { 
            currentSize = e.target.value;
            sizeValue.textContent = currentSize;
        };
        
        document.getElementById('clear-all-btn').onclick = () => {
            if (confirm('í˜„ì¬ í˜ì´ì§€ë¥¼ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                savePage(currentPageIndex); // ë¹ˆ í˜ì´ì§€ ì €ì¥
            }
        };

        // --- í˜ì´ì§€ ë¡œì§ ---
        const pageDisplay = document.getElementById('page-display');

        function updatePageDisplay() {
            pageDisplay.textContent = \`\${currentPageIndex + 1} / \${pages.length}\`;
        }
        
        function savePage(index) {
            pages[index] = canvas.toDataURL('image/png');
        }
        
        function loadPage(index) {
            const dataUrl = pages[index];
            ctx.clearRect(0, 0, canvas.width, canvas.height); // ë¨¼ì € ì§€ìš°ê³ 
            
            if (dataUrl) {
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = dataUrl;
            }
        }
        
        // ì´ˆê¸° 1í˜ì´ì§€ ìƒì„±
        function initializePages() {
            pages.push(null); // ë¹ˆ 1í˜ì´ì§€
            resizeCanvas(); // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • ë° loadPage(0) í˜¸ì¶œ
            updatePageDisplay();
        }
        
        document.getElementById('add-page-btn').onclick = () => {
            savePage(currentPageIndex); // í˜„ì¬ í˜ì´ì§€ ì €ì¥
            pages.push(null); // ìƒˆ ë¹ˆ í˜ì´ì§€ ì¶”ê°€
            currentPageIndex = pages.length - 1; // ìƒˆ í˜ì´ì§€ë¡œ ì´ë™
            loadPage(currentPageIndex);
            updatePageDisplay();
        };

        document.getElementById('prev-page-btn').onclick = () => {
            if (currentPageIndex > 0) {
                savePage(currentPageIndex);
                currentPageIndex--;
                loadPage(currentPageIndex);
                updatePageDisplay();
            }
        };
        
        document.getElementById('next-page-btn').onclick = () => {
            if (currentPageIndex < pages.length - 1) {
                savePage(currentPageIndex);
                currentPageIndex++;
                loadPage(currentPageIndex);
                updatePageDisplay();
            }
        };
        
        initializePages();

        // --- ì €ì¥ ë¡œì§ ---
        function download(href, filename) {
             const a = document.createElement('a');
             a.href = href;
             a.download = filename;
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
        }

        // PNG ì €ì¥
        document.getElementById('save-png-btn').onclick = () => {
            savePage(currentPageIndex); // ìµœì‹  ìƒíƒœ ì €ì¥
            download(pages[currentPageIndex], \`whiteboard_page_\${currentPageIndex + 1}.png\`);
        };

        // í˜„ì¬ í˜ì´ì§€ PDF ì €ì¥
        document.getElementById('save-pdf-btn').onclick = () => {
            savePage(currentPageIndex);
            const doc = new jsPDF({
                orientation: canvas.width > canvas.height ? 'l' : 'p',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            doc.addImage(pages[currentPageIndex], 'PNG', 0, 0, canvas.width, canvas.height);
            doc.save(\`whiteboard_page_\${currentPageIndex + 1}.pdf\`);
        };
        
        // ëª¨ë“  í˜ì´ì§€ PDF ì €ì¥
        document.getElementById('save-all-pdf-btn').onclick = () => {
            savePage(currentPageIndex); // ë§ˆì§€ë§‰ í˜ì´ì§€ ì €ì¥
            
            const doc = new jsPDF({
                orientation: canvas.width > canvas.height ? 'l' : 'p',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            
            pages.forEach((pageData, index) => {
                if (index > 0) {
                    doc.addPage([canvas.width, canvas.height], canvas.width > canvas.height ? 'l' : 'p');
                }
                if (pageData) { // ë¹ˆ í˜ì´ì§€ê°€ ì•„ë‹ ê²½ìš°
                    doc.addImage(pageData, 'PNG', 0, 0, canvas.width, canvas.height);
                }
            });
            
            doc.save('whiteboard_all_pages.pdf');
        };
        
        // ì±„íŒ… ì „ì†¡
        document.getElementById('send-chat-btn').onclick = () => {
            savePage(currentPageIndex); // í˜„ì¬ í˜ì´ì§€ ì €ì¥
            const dataUrl = pages[currentPageIndex];
            
            if (window.opener && !window.opener.closed) {
                // ë©”ì¸ ì°½ì˜ sendWhiteboardCapture í•¨ìˆ˜ í˜¸ì¶œ
                window.opener.sendWhiteMboardCapture(dataUrl);
            } else {
                alert("ë©”ì¸ ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆê±°ë‚˜ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.)");
            }
        };

    <\/script>
</body>
</html>
            `;
        }

    </script>
</body>
</html>
