<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>교사-학생 WebRTC (PeerJS)</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    body { margin:0; font-family:sans-serif; background:#111; color:#eee; }
    #roleGate, #mainLayout { padding:20px; }
    .hidden { display:none; }
    video { width:100%; height:100%; background:black; }
    #videos { display:flex; gap:10px; height:400px; }
    .videoBox { flex:1; position:relative; }
    #chatMessages { height:200px; overflow-y:auto; background:#222; padding:10px; }
    .message { margin-bottom:6px; }
    button { margin:4px; }
    .state-on { background:#1976d2; color:white; }
    .state-off { background:#d32f2f; color:white; }
  </style>
</head>
<body>
  <h1>교사-학생 1:1 화상 & 채팅</h1>

  <section id="roleGate">
    <button id="chooseTeacher">교사로 시작</button>
    <button id="chooseStudent">학생으로 시작</button>

    <div id="teacherFields" class="hidden">
      <input type="password" id="teacherPass" placeholder="교사 비번 a123456!" />
      <button id="teacherStart">교사 시작</button>
    </div>

    <div id="studentFields" class="hidden">
      <input type="text" id="studentName" placeholder="이름" />
      <input type="text" id="roomId" placeholder="화상 아이디" />
      <input type="password" id="roomPass" placeholder="비번 (URL 없이 직접 접속시)" />
      <button id="studentJoin">학생 입장</button>
    </div>
  </section>

  <section id="mainLayout" class="hidden">
    <div id="connectionStatus">대기 중...</div>
    <div id="videos">
      <div class="videoBox"><video id="localVideo" autoplay muted playsinline></video></div>
      <div class="videoBox"><video id="remoteVideo" autoplay playsinline></video></div>
    </div>
    <div>
      <button id="toggleMic" class="state-on">마이크</button>
      <button id="toggleCam" class="state-on">카메라</button>
    </div>
    <div id="chatMessages"></div>
    <input type="text" id="chatText" placeholder="메시지 입력" />
    <button id="sendMsg">보내기</button>
  </section>

<script>
const PASSWORD = "a123456!";
let role=null, peer=null, conn=null, mediaCall=null;
let localStream=null, remoteStream=null;
const localVideo=document.getElementById("localVideo");
const remoteVideo=document.getElementById("remoteVideo");

function appendMessage(who,text){
  const div=document.createElement("div");
  div.className="message";
  div.textContent=`${who}: ${text}`;
  document.getElementById("chatMessages").appendChild(div);
}

document.getElementById("chooseTeacher").onclick=()=> {
  role="teacher";
  document.getElementById("teacherFields").classList.remove("hidden");
  document.getElementById("studentFields").classList.add("hidden");
};
document.getElementById("chooseStudent").onclick=()=> {
  role="student";
  document.getElementById("studentFields").classList.remove("hidden");
  document.getElementById("teacherFields").classList.add("hidden");
};

document.getElementById("teacherStart").onclick=async()=>{
  if(document.getElementById("teacherPass").value!==PASSWORD){alert("비번 오류");return;}
  role="teacher";
  const roomId="class-"+Math.random().toString(36).substr(2,6);
  await initPeer(roomId);
  document.getElementById("mainLayout").classList.remove("hidden");
  document.getElementById("roleGate").classList.add("hidden");
  appendMessage("시스템","교사 방 생성: "+roomId);
};

document.getElementById("studentJoin").onclick=async()=>{
  const roomId=document.getElementById("roomId").value.trim();
  if(!roomId){alert("아이디 입력");return;}
  if(document.getElementById("roomPass").value!==PASSWORD){alert("비번 오류");return;}
  await initPeer("student-"+Math.random().toString(36).substr(2,6), roomId);
  document.getElementById("mainLayout").classList.remove("hidden");
  document.getElementById("roleGate").classList.add("hidden");
};

async function initPeer(myId, connectTo=null){
  localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject=localStream;
  peer=new Peer(myId);
  peer.on("open",id=>{
    if(role==="student" && connectTo){
      conn=peer.connect(connectTo);
      conn.on("data",d=>appendMessage("상대",d));
      mediaCall=peer.call(connectTo,localStream);
      // 학생도 상대방 스트림 받기
      mediaCall.on("stream",stream=>{
        remoteStream=stream;
        remoteVideo.srcObject=stream;
        appendMessage("시스템","화상 연결됨");
      });
    }
  });
  peer.on("connection",c=>{
    conn=c;
    conn.on("data",d=>appendMessage("상대",d));
  });
  peer.on("call",call=>{
    mediaCall=call;
    call.answer(localStream);
    // 교사도 상대방 스트림 받기
    call.on("stream",stream=>{
      remoteStream=stream;
      remoteVideo.srcObject=stream;
      appendMessage("시스템","화상 연결됨");
    });
  });
}

document.getElementById("sendMsg").onclick=()=>{
  const txt=document.getElementById("chatText").value;
  appendMessage("나",txt);
  if(conn) conn.send(txt);
  document.getElementById("chatText").value="";
};

document.getElementById("toggleMic").onclick=()=>{
  localStream.getAudioTracks().forEach(t=>t.enabled=!t.enabled);
  const on=localStream.getAudioTracks()[0].enabled;
  document.getElementById("toggleMic").className=on?"state-on":"state-off";
};
document.getElementById("toggleCam").onclick=()=>{
  localStream.getVideoTracks().forEach(t=>t.enabled=!t.enabled);
  const on=localStream.getVideoTracks()[0].enabled;
  document.getElementById("toggleCam").className=on?"state-on":"state-off";
};
</script>
</body>
</html>
